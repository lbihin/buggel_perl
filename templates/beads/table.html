{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/beads-table.css' %}" />
{% endblock %}

{% block content %}
  <div class="page-header">
    <div>
      <h2><i class="bi bi-palette2 me-2 text-muted"></i>Ma collection de perles</h2>
      <p class="subtitle">Gérez vos perles et suivez vos stocks</p>
    </div>
    <a href="{% url 'beads:create' %}" class="btn btn-primary btn-sm rounded-pill px-3"><i class="bi bi-plus-lg me-1"></i>Ajouter</a>
  </div>

  <!-- Messages -->
  <div id="messages-container" hx-get="{% url 'beads:stock_alert_htmx' %}" hx-trigger="quantityUpdated from:body" hx-swap="innerHTML">
    {% if low_quantity_beads %}
      <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Stock faible :</strong> {{ low_quantity_beads|length }} perle{{ low_quantity_beads|length|pluralize }} en dessous de {{ threshold }} unités.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endif %}
  </div>

  {% if beads %}
    <div class="table-modern">
      <table class="beads-table w-100 mb-0">
        <thead>
          <tr>
            <th>Couleur</th>
            <th>Nom</th>
            <th>Quantité</th>
            <th>Notes</th>
            <th class="text-end" style="width:80px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for bead in beads %}
            <tr id="bead-row-{{ bead.pk }}" class="{% if bead.quantity is not None and bead.quantity < threshold %}low-quantity{% endif %}">
              <td>
                <div id="clr-{{ bead.pk }}">
                  {% include 'beads/partials/bead_color_display.html' with bead=bead %}
                </div>
              </td>
              <td class="fw-medium">{{ bead.name }}</td>
              <td>
                <div id="qty-{{ bead.pk }}">
                  {% include 'beads/partials/bead_quantity_display.html' with bead=bead threshold=threshold %}
                </div>
              </td>
              <td class="text-muted" style="font-size:.85rem;">{{ bead.notes|default:'-'|truncatewords:8 }}</td>
              <td class="text-end">
                <a href="{% url 'beads:edit' bead.pk %}" class="btn btn-sm btn-light" title="Modifier"><i class="bi bi-pencil"></i></a>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    <p class="text-muted mt-3" style="font-size:.82rem;">
      <i class="bi bi-info-circle me-1"></i>Cliquez sur la couleur ou la quantité pour les modifier directement.
    </p>
  {% else %}
    <div class="empty-state-card">
      <i class="bi bi-palette2"></i>
      <p>Vous n'avez pas encore ajouté de perles.</p>
      <a href="{% url 'beads:create' %}" class="btn btn-primary btn-sm rounded-pill px-4"><i class="bi bi-plus-lg me-1"></i>Ajouter ma première perle</a>
    </div>
  {% endif %}
{% endblock %}

{% block extra_js %}
  <script>
    // Update row low-quantity class after inline quantity change
    document.body.addEventListener('quantityUpdated', function (e) {
      var d = e.detail
      if (d && d.beadId) {
        var row = document.getElementById('bead-row-' + d.beadId)
        if (row) {
          row.classList.toggle('low-quantity', !!d.isLow)
        }
      }
    })
  </script>
{% endblock %}
