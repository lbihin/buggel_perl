{% extends 'base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/beads-table.css' %}" />
{% endblock %}

{% block content %}
  <div class="page-header">
    <div>
      <h2><i class="bi bi-palette2 me-2 text-muted"></i>Ma collection de perles</h2>
      <p class="subtitle">Gérez vos perles et suivez vos stocks</p>
    </div>
    <button class="btn btn-primary btn-sm rounded-pill px-3"
            hx-get="{% url 'beads:bead_new_row_htmx' %}"
            hx-target="#beads-tbody"
            hx-swap="beforeend"
            onclick="var n=document.getElementById('bead-row-new'); if(n){n.querySelector('input[name=name]').focus();event.preventDefault();return;} var e=document.getElementById('empty-state-row'); if(e) e.remove();">
      <i class="bi bi-plus-lg me-1"></i>Ajouter
    </button>
  </div>

  <!-- Messages -->
  <div id="messages-container" hx-get="{% url 'beads:stock_alert_htmx' %}" hx-trigger="quantityUpdated from:body" hx-swap="innerHTML">
    {% if low_quantity_beads %}
      <div class="alert alert-warning alert-dismissible fade show" role="alert">
        <i class="bi bi-exclamation-triangle me-2"></i>
        <strong>Stock faible :</strong> {{ low_quantity_beads|length }} perle{{ low_quantity_beads|length|pluralize }} en dessous de {{ threshold }} unités.
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endif %}
  </div>

  <div class="table-modern">
    <table class="beads-table w-100 mb-0">
      <thead>
        <tr>
          <th>Couleur</th>
          <th>Nom</th>
          <th>Quantité</th>
          <th>Notes</th>
          <th class="th-row-actions"></th>
        </tr>
      </thead>
      <tbody id="beads-tbody">
        {% for bead in beads %}
          {% include 'beads/partials/bead_row_display.html' with bead=bead threshold=threshold %}
        {% empty %}
          <tr id="empty-state-row">
            <td colspan="5" class="text-center py-5">
              <div class="py-3">
                <i class="bi bi-palette2 fs-1 text-muted d-block mb-2"></i>
                <p class="text-muted mb-0">Aucune perle. Cliquez « Ajouter » pour commencer.</p>
              </div>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <p class="text-muted mt-3" style="font-size:.82rem;">
    <i class="bi bi-info-circle me-1"></i>Survolez une ligne et cliquez sur le stylo pour modifier.
  </p>
{% endblock %}

{% block extra_js %}
  <script>
    // Update row low-quantity class after inline quantity change
    document.body.addEventListener('quantityUpdated', function (e) {
      var d = e.detail
      if (d && d.beadId) {
        var row = document.getElementById('bead-row-' + d.beadId)
        if (row) {
          row.classList.toggle('low-quantity', !!d.isLow)
        }
      }
    })
  </script>
{% endblock %}
