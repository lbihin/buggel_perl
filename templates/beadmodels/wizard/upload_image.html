{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/wizard.css' %}" />
{% endblock %}

{% block content %}
  <div class="wizard-layout">
    {# ── Stepper ── #}
    <div class="wizard-stepper">
      <div class="wizard-step-item active">
        <div class="step-circle">1</div>
        <div class="step-label">
          {% trans 'Image' %}
        </div>
      </div>
      <div class="wizard-step-item pending">
        <div class="step-circle">2</div>
        <div class="step-label">
          {% trans 'Configuration' %}
        </div>
      </div>
      <div class="wizard-step-item pending">
        <div class="step-circle">3</div>
        <div class="step-label">
          {% trans 'Finalisation' %}
        </div>
      </div>
    </div>

    {# ── Card ── #}
    <div class="wizard-card">
      <div class="wizard-card-body">
        <form method="post" action="{% url 'beadmodels:create' %}" enctype="multipart/form-data" id="uploadForm">
          {% csrf_token %}

          {% if form.errors %}
            <div class="alert alert-danger mb-3">
              <i class="bi bi-exclamation-triangle me-1"></i>
              {% trans 'Veuillez corriger les erreurs ci-dessous.' %}
              {% for error in form.non_field_errors %}
                <div>{{ error }}</div>
              {% endfor %}
              {% for error in form.image.errors %}
                <div>{{ error }}</div>
              {% endfor %}
            </div>
          {% endif %}

          {# Drop zone #}
          <div class="drop-zone" id="dropZone">
            <div class="drop-zone-icon">
              <i class="bi bi-cloud-arrow-up"></i>
            </div>
            <div class="drop-zone-title">
              {% trans 'Glissez votre image ici' %}
            </div>
            <div class="drop-zone-subtitle">
              {% trans 'ou' %} <span class="link" id="browseLink">{% trans 'parcourez vos fichiers' %}</span>
            </div>
            <div class="mt-2" style="font-size:.78rem; color:#adb5bd;">
              {% trans 'PNG, JPG, WEBP — max 10 Mo' %}
            </div>
            <div style="display:none;">{{ form.image }}</div>
          </div>

          {# Upload preview #}
          <div class="text-center" id="previewArea" style="display:none;">
            <div class="upload-preview">
              <img id="previewImg" src="" alt="{% trans 'Aperçu' %}" />
              <button type="button" class="remove-btn" id="removeBtn" title="{% trans "Retirer l'image" %}"><i class="bi bi-x"></i></button>
            </div>
          </div>

          {# Navigation #}
          <div class="wizard-nav">
            <a href="{% url 'home' %}" class="btn btn-outline-secondary"><i class="bi bi-x-lg me-1"></i> {% trans 'Annuler' %}</a>
            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>{% trans 'Suivant' %} <i class="bi bi-arrow-right ms-1"></i></button>
          </div>
        </form>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const dropZone = document.getElementById('dropZone')
      const fileInput = document.querySelector('input[type="file"]')
      const browseLink = document.getElementById('browseLink')
      const previewArea = document.getElementById('previewArea')
      const previewImg = document.getElementById('previewImg')
      const removeBtn = document.getElementById('removeBtn')
      const submitBtn = document.getElementById('submitBtn')

      browseLink.addEventListener('click', e => { e.stopPropagation(); fileInput.click() })
      dropZone.addEventListener('click', () => fileInput.click())

      ;['dragenter', 'dragover'].forEach(evt => {
        dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.add('dragover') })
      })
      ;['dragleave', 'drop'].forEach(evt => {
        dropZone.addEventListener(evt, e => { e.preventDefault(); dropZone.classList.remove('dragover') })
      })
      dropZone.addEventListener('drop', e => {
        if (e.dataTransfer.files.length) {
          fileInput.files = e.dataTransfer.files
          showPreview(e.dataTransfer.files[0])
        }
      })

      fileInput.addEventListener('change', function () {
        if (this.files && this.files[0]) showPreview(this.files[0])
      })

      removeBtn.addEventListener('click', function () {
        fileInput.value = ''
        previewArea.style.display = 'none'
        dropZone.style.display = ''
        submitBtn.disabled = true
      })

      function showPreview(file) {
        const reader = new FileReader()
        reader.onload = function (e) {
          previewImg.src = e.target.result
          previewArea.style.display = ''
          dropZone.style.display = 'none'
          submitBtn.disabled = false
        }
        reader.readAsDataURL(file)
      }
    })
  </script>
{% endblock %}
