{% extends 'base.html' %}
{% load i18n %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/wizard.css' %}" />
{% endblock %}

{% block title %}{% trans "Finalisation du modèle" %}{% endblock %}

{% block content %}
  <div class="wizard-layout">
    {# ── Stepper ── #}
    <div class="wizard-stepper">
      <div class="wizard-step-item done">
        <div class="step-circle"><i class="bi bi-check2"></i></div>
        <div class="step-label">{% trans "Image" %}</div>
      </div>
      <div class="wizard-step-item done">
        <div class="step-circle"><i class="bi bi-check2"></i></div>
        <div class="step-label">{% trans "Configuration" %}</div>
      </div>
      <div class="wizard-step-item active">
        <div class="step-circle">3</div>
        <div class="step-label">{% trans "Finalisation" %}</div>
      </div>
    </div>

    {# ── Card ── #}
    <div class="wizard-card">
      <div class="wizard-card-body">
        <div class="finalize-layout">

          {# ── Left: Preview + Stats + Palette ── #}
          <div>
            {# Image #}
            <div class="finalize-preview">
              {% if image_base64 %}
                <img src="data:image/png;base64,{{ image_base64 }}" alt="{% trans "Prévisualisation finale" %}" />
              {% else %}
                <div class="text-muted">{% trans "Image finale introuvable." %}</div>
              {% endif %}
            </div>

            {# Stats #}
            <div class="stat-pills mt-3">
              <div class="stat-pill">
                <strong>{{ grid_width }} × {{ grid_height }}</strong>
                <span>{% trans "dimensions" %}</span>
              </div>
              <div class="stat-pill">
                <strong>{{ total_beads }}</strong>
                <span>{% trans "perles utiles" %}</span>
              </div>
              <div class="stat-pill">
                <strong>{{ beads_count }}</strong>
                <span>{% trans "couleurs" %}</span>
              </div>
              <div class="stat-pill">
                <strong>{{ shape_name }}</strong>
                <span>{{ shape_type }}</span>
              </div>
            </div>

            {# Palette swatches #}
            {% if palette %}
              <div class="config-section-label">{% trans "Palette" %}</div>
              <div class="palette-row">
                {% for c in palette %}
                  {% if not c.is_background %}
                    <div class="palette-dot" style="background:{{ c.color }};" title="{% blocktrans with hex=c.hex count=c.count pct=c.percentage %}{{ hex }} — {{ count }} perles ({{ pct }}%){% endblocktrans %}"></div>
                  {% endif %}
                {% endfor %}
              </div>

              {# Expanded palette table #}
              <details class="mt-2">
                <summary style="font-size:.82rem;color:#868e96;cursor:pointer;">{% trans "Détails de la palette" %}</summary>
                <div class="mt-2">
                  {% for c in palette %}
                    {% if not c.is_background %}
                      <div class="d-flex align-items-center gap-2 py-1" style="font-size:.82rem;">
                        <span class="rounded" style="display:inline-block;width:18px;height:18px;background:{{ c.color }};border:1px solid #dee2e6;flex-shrink:0;"></span>
                        <strong>{{ c.count }}</strong>
                        <span class="text-muted">({{ c.percentage }}%)</span>
                        {% if c.matches %}
                          <span class="text-muted">→</span>
                          {% for m in c.matches %}
                            <span style="display:inline-block;width:10px;height:10px;background:{{ m.color }};border:1px solid #ccc;border-radius:2px;"></span>
                            <span>{{ m.name }}</span>
                          {% endfor %}
                        {% endif %}
                      </div>
                    {% endif %}
                  {% endfor %}
                  {% for c in palette %}
                    {% if c.is_background %}
                      <div class="mt-2 text-muted" style="font-size:.78rem;">
                        <i class="bi bi-info-circle me-1"></i>{% trans "Fond détecté :" %}
                        <span style="display:inline-block;width:12px;height:12px;background:{{ c.color }};border:1px solid #ccc;border-radius:2px;"></span>
                        {{ c.hex }} ({% blocktrans with count=c.count %}{{ count }} perles exclues{% endblocktrans %})
                      </div>
                    {% endif %}
                  {% endfor %}
                </div>
              </details>
            {% endif %}
          </div>

          {# ── Right: Save form ── #}
          <div>
            <form method="post" class="save-form-card">
              {% csrf_token %}
              {{ form.non_field_errors }}

              <div class="mb-3">
                <label for="{{ form.name.id_for_label }}" class="form-label">{{ form.name.label }}</label>
                {{ form.name }}
                {{ form.name.errors }}
              </div>

              <div class="mb-3">
                <div class="form-check form-switch">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    role="switch"
                    id="{{ form.is_public.id_for_label }}"
                    name="is_public"
                    {% if form.is_public.value %}checked{% endif %}
                  >
                  <label class="form-check-label fw-medium" for="{{ form.is_public.id_for_label }}" id="visibility-label">
                    {% if form.is_public.value %}{% trans "Public" %}{% else %}{% trans "Privé" %}{% endif %}
                  </label>
                </div>
                <small class="d-block form-text text-muted" id="visibility-hint">
                  {% if form.is_public.value %}
                    {% trans "Sera visible par les autres utilisateurs" %}
                  {% else %}
                    {% trans "Ne sera visible que par vous" %}
                  {% endif %}
                </small>
              </div>

              <details class="mb-3">
                <summary style="font-size:.82rem;color:#868e96;cursor:pointer;">
                  <i class="bi bi-plus-circle me-1"></i>{% trans "Options avancées" %}
                </summary>
                <div class="mt-2">
                  <div class="mb-3">
                    <label for="{{ form.description.id_for_label }}" class="form-label">{{ form.description.label }}</label>
                    {{ form.description }}
                    {{ form.description.errors }}
                  </div>
                  <div class="mb-3">
                    <label for="{{ form.tags.id_for_label }}" class="form-label">{{ form.tags.label }}</label>
                    {{ form.tags }}
                    {% if form.tags.help_text %}
                      <small class="form-text text-muted">{{ form.tags.help_text }}</small>
                    {% endif %}
                    {{ form.tags.errors }}
                  </div>
                </div>
              </details>

              <div class="d-grid gap-2 mt-4">
                <button type="submit" name="save" class="btn btn-primary">
                  <i class="bi bi-save me-1"></i> {% trans "Enregistrer" %}
                </button>
                <div class="d-flex gap-2">
                  <button type="submit" name="download" value="png" class="btn btn-outline-secondary flex-fill" formnovalidate>
                    <i class="bi bi-download me-1"></i> PNG
                  </button>
                  <button type="submit" name="download" value="pdf" class="btn btn-outline-secondary flex-fill" formnovalidate>
                    <i class="bi bi-file-earmark-pdf me-1"></i> PDF
                  </button>
                </div>
              </div>

              <div class="wizard-nav" style="border-top:none;margin-top:1rem;padding-top:0;">
                <button type="submit" name="previous_step" class="btn btn-outline-secondary" formnovalidate>
                  <i class="bi bi-arrow-left me-1"></i> {% trans "Retour" %}
                </button>
                <button type="submit" name="download_instructions" class="btn btn-outline-secondary btn-sm" formnovalidate>
                  <i class="bi bi-file-earmark-text me-1"></i> {% trans "Instructions" %}
                </button>
              </div>
            </form>
          </div>

        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const toggle = document.getElementById('{{ form.is_public.id_for_label }}');
  const label = document.getElementById('visibility-label');
  const hint = document.getElementById('visibility-hint');
  if (toggle && label && hint) {
    toggle.addEventListener('change', function () {
      if (this.checked) {
        label.textContent = '{{ "Public"|escapejs }}';
        hint.textContent = '{{ "Sera visible par les autres utilisateurs"|escapejs }}';
      } else {
        label.textContent = '{{ "Privé"|escapejs }}';
        hint.textContent = '{{ "Ne sera visible que par vous"|escapejs }}';
      }
    });
  }
});
</script>
{% endblock %}
