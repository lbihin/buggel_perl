{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load math_filters %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/wizard.css' %}" />
{% endblock %}

{% block content %}
  <div class="wizard-layout">
    {# ── Stepper ── #}
    <div class="wizard-stepper">
      <div class="wizard-step-item done">
        <div class="step-circle"><i class="bi bi-check2"></i></div>
        <div class="step-label">{% trans "Image" %}</div>
      </div>
      <div class="wizard-step-item active">
        <div class="step-circle">2</div>
        <div class="step-label">{% trans "Configuration" %}</div>
      </div>
      <div class="wizard-step-item pending">
        <div class="step-circle">3</div>
        <div class="step-label">{% trans "Finalisation" %}</div>
      </div>
    </div>

    {# ── Card ── #}
    <div class="wizard-card">
      <div class="wizard-card-body">

        {% if form.errors %}
          <div class="alert alert-danger mb-3">
            <i class="bi bi-exclamation-triangle me-1"></i>
            {% trans "Veuillez corriger les erreurs ci-dessous." %}
            {% for error in form.non_field_errors %}<div>{{ error }}</div>{% endfor %}
          </div>
        {% endif %}

        {# ── AI Suggestion Card ── #}
        {% if suggestions %}
          <div class="suggestion-card">
            <div class="suggestion-header">
              <i class="bi bi-magic me-2"></i>{% trans "Analyse de l'image" %}
            </div>
            <div class="suggestion-body">
              <div class="suggestion-metrics">
                {% if suggestion_shape_label %}
                  <div class="suggestion-metric">
                    <span class="suggestion-metric-value">
                      {% if suggestions.suggested_shape == "circle" %}<i class="bi bi-circle"></i>
                      {% elif suggestions.suggested_shape == "square" %}<i class="bi bi-square-fill"></i>
                      {% else %}<i class="bi bi-square"></i>{% endif %}
                      {{ suggestion_shape_label }}
                    </span>
                    <span class="suggestion-metric-label">{% trans "forme" %}</span>
                  </div>
                {% endif %}
                <div class="suggestion-metric">
                  <span class="suggestion-metric-value">{{ suggestions.suggested_colors }}</span>
                  <span class="suggestion-metric-label">{% trans "couleurs" %}</span>
                </div>
                <div class="suggestion-metric">
                  <span class="suggestion-metric-value">{{ suggestions.suggested_size }}</span>
                  <span class="suggestion-metric-label">{% trans "taille" %}</span>
                </div>
                <div class="suggestion-metric">
                  <span class="suggestion-metric-value">
                    {% widthratio suggestions.fill_ratio 1 100 %}%
                  </span>
                  <span class="suggestion-metric-label">{% trans "efficacité" %}</span>
                </div>
              </div>
              {% if suggestions.dominant_colors %}
                <div class="suggestion-palette">
                  {% for hex in suggestions.dominant_colors %}
                    <span class="suggestion-dot" style="background:{{ hex }};"></span>
                  {% endfor %}
                  <span class="suggestion-palette-label">{% trans "couleurs dominantes" %}</span>
                </div>
              {% endif %}
            </div>
          </div>
        {% endif %}

        {# ── Side-by-side panels ── #}
        <div class="config-panels">
          {# Left: original image #}
          <div class="config-panel">
            <div class="config-panel-label">{% trans "Image originale" %}</div>
            <div class="config-panel-img">
              {% if image_base64 %}
                <img src="data:image/png;base64,{{ image_base64 }}" alt="{% trans "Image originale" %}" />
              {% else %}
                <div class="text-muted p-3">
                  {% trans "Aucune image chargée." %} <a href="{% url 'beadmodels:create' %}">{% trans "Retour" %}</a>.
                </div>
              {% endif %}
            </div>
          </div>

          {# Right: live preview #}
          <div class="config-panel" style="position:relative;">
            <div class="config-panel-label">
              {% trans "Aperçu pixelisé" %}
              <span class="htmx-indicator preview-spinner">
                <span class="spinner-border spinner-border-sm" role="status"></span>
              </span>
            </div>
            <div class="config-panel-img" id="preview-container">
              {% include 'beadmodels/wizard/partials/preview.html' %}
            </div>
          </div>
        </div>

        {# ── Controls ── #}
        <form method="post" class="needs-validation" novalidate>
          {% csrf_token %}

          {# Shape selector #}
          <div class="config-section">
            <div class="config-section-label">{% trans "Forme de la plaque" %}</div>
            <div class="chip-group">
              {% for shape in user_shapes %}
                <input
                  type="radio"
                  name="shape_id"
                  id="shape_{{ shape.id }}"
                  value="{{ shape.id }}"
                  {% if selected_shape_id|stringformat:"s" == shape.id|stringformat:"s" %}checked{% endif %}
                  hx-post="{% url 'beadmodels:hx-config-change-shape' shape.id %}"
                  hx-trigger="change"
                  hx-target="#preview-container"
                  hx-indicator=".preview-spinner"
                >
                <label for="shape_{{ shape.id }}"
                  {% if suggestions and shape.shape_type == suggestions.suggested_shape %}
                    class="recommended" title="{% trans 'Recommandé par l\'analyse' %}"
                  {% endif %}
                >
                  {% if shape.shape_type == "circle" %}<i class="bi bi-circle me-1" style="font-size:.75em;"></i>
                  {% elif shape.shape_type == "square" %}<i class="bi bi-square-fill me-1" style="font-size:.75em;"></i>
                  {% else %}<i class="bi bi-square me-1" style="font-size:.75em;"></i>{% endif %}
                  {{ shape.name }}
                  {% if suggestions and shape.shape_type == suggestions.suggested_shape %}
                    <i class="bi bi-star-fill ms-1" style="font-size:.6em;vertical-align:super;color:var(--bs-warning)"></i>
                  {% endif %}
                </label>
              {% endfor %}
            </div>
          </div>

          {# Color count selector #}
          <div class="config-section">
            <div class="config-section-label">{% trans "Nombre de couleurs" %}</div>
            {{ form.color_reduction }}
            <div class="chip-group">
              {% for value in color_values %}
                <input
                  type="radio"
                  name="color_reduction"
                  id="color_{{ value }}"
                  value="{{ value }}"
                  {% if form.color_reduction.value|stringformat:'s' == value|stringformat:'s' %}checked
                  {% elif not form.color_reduction.value and value|stringformat:'s' == suggested_colors|stringformat:'s' %}checked{% endif %}
                  hx-post="{% url 'beadmodels:hx-config-change-max-colors' value %}"
                  hx-trigger="change"
                  hx-target="#preview-container"
                  hx-indicator=".preview-spinner"
                >
                <label for="color_{{ value }}"
                  {% if value|stringformat:'s' == suggested_colors|stringformat:'s' %}
                    class="recommended" title="{% trans 'Recommandé pour cette image' %}"
                  {% endif %}
                >{{ value }}{% if value|stringformat:'s' == suggested_colors|stringformat:'s' %} <i class="bi bi-star-fill" style="font-size:.65em;vertical-align:super;color:var(--bs-warning)"></i>{% endif %}</label>
              {% endfor %}
            </div>
            {% if suggested_colors %}
              <small class="d-block text-muted mt-1" style="font-size:.75rem;">
                <i class="bi bi-lightbulb me-1"></i>{% trans "Recommandé" %}: <strong>{{ suggested_colors }}</strong> {% trans "couleurs détectées dans l'image" %}
              </small>
            {% endif %}
          </div>

          {# Use available colors toggle #}
          <div class="config-section">
            <label class="config-toggle">
              {{ form.use_available_colors }}
              {{ form.use_available_colors.label }}
            </label>
            {% if form.use_available_colors.help_text %}
              <small class="d-block text-muted mt-1" style="font-size:.78rem;">{{ form.use_available_colors.help_text }}</small>
            {% endif %}
          </div>

          {# Bead economy indicator #}
          {% if suggestions.fill_ratio %}
            <div class="config-section">
              <div class="bead-economy">
                <i class="bi bi-graph-up me-1"></i>
                <span>
                  {% trans "Efficacité d'utilisation" %}:
                  <strong>{% widthratio suggestions.fill_ratio 1 100 %}%</strong>
                </span>
                <div class="economy-bar">
                  <div class="economy-fill" style="width:{% widthratio suggestions.fill_ratio 1 100 %}%"></div>
                </div>
                <small class="text-muted">{% trans "Ratio contenu/espace de la plaque" %}</small>
              </div>
            </div>
          {% endif %}

          {# Navigation #}
          <div class="wizard-nav">
            <button type="submit" name="q" value="previous" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-1"></i> {% trans "Retour" %}
            </button>
            <button type="submit" name="q" value="next" class="btn btn-primary">
              {% trans "Générer le modèle" %} <i class="bi bi-arrow-right ms-1"></i>
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
{% endblock %}