{% extends 'base.html' %}
{% load i18n %}
{% load static %}
{% load math_filters %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/wizard.css' %}" />
{% endblock %}

{% block content %}
  <div class="wizard-layout">
    {# ── Stepper ── #}
    <div class="wizard-stepper">
      <div class="wizard-step-item done">
        <div class="step-circle"><i class="bi bi-check2"></i></div>
        <div class="step-label">{% trans "Image" %}</div>
      </div>
      <div class="wizard-step-item active">
        <div class="step-circle">2</div>
        <div class="step-label">{% trans "Configuration" %}</div>
      </div>
      <div class="wizard-step-item pending">
        <div class="step-circle">3</div>
        <div class="step-label">{% trans "Finalisation" %}</div>
      </div>
    </div>

    {# ── Card ── #}
    <div class="wizard-card">
      <div class="wizard-card-body">

        {% if form.errors %}
          <div class="alert alert-danger mb-3">
            <i class="bi bi-exclamation-triangle me-1"></i>
            {% trans "Veuillez corriger les erreurs ci-dessous." %}
            {% for error in form.non_field_errors %}<div>{{ error }}</div>{% endfor %}
          </div>
        {% endif %}

        {# ── Side-by-side panels ── #}
        <div class="config-panels">
          {# Left: original image #}
          <div class="config-panel">
            <div class="config-panel-label">{% trans "Image originale" %}</div>
            <div class="config-panel-img">
              {% if image_base64 %}
                <img src="data:image/png;base64,{{ image_base64 }}" alt="{% trans "Image originale" %}" />
              {% else %}
                <div class="text-muted p-3">
                  {% trans "Aucune image chargée." %} <a href="{% url 'beadmodels:create' %}">{% trans "Retour" %}</a>.
                </div>
              {% endif %}
            </div>
          </div>

          {# Right: live preview #}
          <div class="config-panel" style="position:relative;">
            <div class="config-panel-label">
              {% trans "Aperçu pixelisé" %}
              <span class="htmx-indicator preview-spinner">
                <span class="spinner-border spinner-border-sm" role="status"></span>
              </span>
            </div>
            <div class="config-panel-img" id="preview-container">
              {% include 'beadmodels/wizard/partials/preview.html' %}
            </div>
          </div>
        </div>

        {# ── Controls ── #}
        <form method="post" class="needs-validation" novalidate>
          {% csrf_token %}

          {# Shape selector #}
          <div class="config-section">
            <div class="config-section-label">{% trans "Forme de la plaque" %}</div>
            <div class="chip-group">
              {% for shape in user_shapes %}
                <input
                  type="radio"
                  name="shape_id"
                  id="shape_{{ shape.id }}"
                  value="{{ shape.id }}"
                  {% if selected_shape_id|stringformat:"s" == shape.id|stringformat:"s" %}checked{% endif %}
                  hx-post="{% url 'beadmodels:hx-config-change-shape' shape.id %}"
                  hx-trigger="change"
                  hx-target="#preview-container"
                  hx-indicator=".preview-spinner"
                >
                <label for="shape_{{ shape.id }}">{{ shape.name }}</label>
              {% endfor %}
            </div>
          </div>

          {# Color count selector #}
          <div class="config-section">
            <div class="config-section-label">{% trans "Nombre de couleurs" %}</div>
            {{ form.color_reduction }}
            <div class="chip-group">
              {% for value in color_values %}
                <input
                  type="radio"
                  name="color_reduction"
                  id="color_{{ value }}"
                  value="{{ value }}"
                  {% if form.color_reduction.value|stringformat:'s' == value|stringformat:'s' %}checked
                  {% elif not form.color_reduction.value and value == 16 %}checked{% endif %}
                  hx-post="{% url 'beadmodels:hx-config-change-max-colors' value %}"
                  hx-trigger="change"
                  hx-target="#preview-container"
                  hx-indicator=".preview-spinner"
                >
                <label for="color_{{ value }}">{{ value }}</label>
              {% endfor %}
            </div>
          </div>

          {# Use available colors toggle #}
          <div class="config-section">
            <label class="config-toggle">
              {{ form.use_available_colors }}
              {{ form.use_available_colors.label }}
            </label>
            {% if form.use_available_colors.help_text %}
              <small class="d-block text-muted mt-1" style="font-size:.78rem;">{{ form.use_available_colors.help_text }}</small>
            {% endif %}
          </div>

          {# Navigation #}
          <div class="wizard-nav">
            <button type="submit" name="q" value="previous" class="btn btn-outline-secondary">
              <i class="bi bi-arrow-left me-1"></i> {% trans "Retour" %}
            </button>
            <button type="submit" name="q" value="next" class="btn btn-primary">
              {% trans "Générer le modèle" %} <i class="bi bi-arrow-right ms-1"></i>
            </button>
          </div>
        </form>

      </div>
    </div>
  </div>
{% endblock %}
