{% extends 'base.html' %}
{% load i18n %}

{% block extra_css %}
  <style>
    /* Fill viewport — reduced to 75vh for balance */
    .detail-page {
      display: flex;
      gap: 1.5rem;
      height: calc(75vh - 40px);
      min-height: 360px;
    }
    
    /* Left: pattern showcase */
    .pattern-panel {
      flex: 1 1 0;
      position: relative;
      background: radial-gradient(circle at 25% 40%, rgba(99, 102, 241, 0.05) 0%, transparent 50%), radial-gradient(circle at 75% 60%, rgba(236, 72, 153, 0.05) 0%, transparent 50%), linear-gradient(160deg, #f1f3f5, #e9ecef);
      border-radius: 1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
    }
    .pattern-panel img {
      image-rendering: pixelated;
      /* Fill container — object-fit:contain keeps aspect ratio */
      width: 85%;
      height: 85%;
      object-fit: contain;
      border-radius: 0.5rem;
      box-shadow: 0 6px 32px rgba(0, 0, 0, 0.09);
    }
    .pattern-panel .overlay-actions {
      position: absolute;
      top: 0.75rem;
      right: 0.75rem;
      opacity: 0;
      transition: opacity 0.2s;
    }
    .pattern-panel:hover .overlay-actions {
      opacity: 1;
    }
    
    /* Right: info sidebar */
    .info-panel {
      width: 340px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      overflow-y: auto;
      padding-right: 0.25rem;
    }
    
    /* Inline edit */
    .editable-field .edit-icon {
      opacity: 0;
      transition: opacity 0.15s;
    }
    .editable-field:hover .edit-icon {
      opacity: 1;
    }
    .editable-field {
      cursor: pointer;
      transition: background 0.15s;
      border-radius: 0.25rem;
    }
    .editable-field:hover {
      background: rgba(0, 0, 0, 0.04);
    }
    
    /* Section label */
    .section-lbl {
      font-size: 0.78rem;
      text-transform: uppercase;
      letter-spacing: 0.06em;
      color: #868e96;
      font-weight: 600;
      margin-bottom: 0.4rem;
    }
    
    /* Stat chip */
    .stat-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      background: #f1f3f5;
      border-radius: 0.5rem;
      padding: 0.4rem 0.75rem;
      font-size: 0.92rem;
    }
    .stat-chip strong {
      color: #212529;
    }
    .stat-chip span {
      color: #868e96;
      font-size: 0.8rem;
    }
    
    /* Palette swatch */
    .swatch {
      width: 26px;
      height: 26px;
      border-radius: 50%;
      border: 2px solid #fff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.13);
      display: inline-block;
      transition: transform 0.15s;
      cursor: default;
    }
    .swatch:hover {
      transform: scale(1.3);
      z-index: 1;
    }
    
    /* Original thumb + hover zoom */
    .original-wrap {
      position: relative;
      display: inline-block;
    }
    .original-thumb {
      width: 56px;
      height: 56px;
      object-fit: cover;
      border-radius: 0.4rem;
      border: 2px solid #fff;
      box-shadow: 0 1px 4px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      transition: box-shadow 0.2s;
    }
    .original-thumb:hover {
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.2);
    }
    .original-zoom {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: min(500px, 70vw);
      max-height: min(500px, 70vh);
      object-fit: contain;
      background: #fff;
      border-radius: 1rem;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 1rem;
      z-index: 9999;
      pointer-events: none;
    }
    .original-wrap:hover .original-zoom {
      display: block;
    }
    
    /* Download strip */
    .dl-strip {
      display: flex;
      gap: 0.5rem;
    }
    .dl-strip .btn {
      flex: 1;
      font-size: 0.9rem;
    }
    
    /* Meta line */
    .meta-line {
      font-size: 0.88rem;
      color: #868e96;
      display: flex;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
    }
    
    /* Empty state */
    .empty-pattern {
      flex: 1 1 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: #f8f9fa;
      border-radius: 1rem;
      color: #adb5bd;
    }
    
    /* Responsive: stack on mobile */
    @media (max-width: 768px) {
      .detail-page {
        flex-direction: column;
        height: auto;
      }
      .pattern-panel {
        min-height: 50vh;
      }
      .info-panel {
        width: 100%;
      }
    }
  </style>
{% endblock %}

{% block content %}
  <div class="detail-page">
    {# === LEFT: Pattern showcase === #}
    {% if model.bead_pattern %}
      <div class="pattern-panel">
        <img src="{{ model.bead_pattern.url }}" alt="{% blocktrans with name=model.name %}Modèle en perles — {{ name }}{% endblocktrans %}" />
        {% if user == model.creator %}
          <div class="overlay-actions">
            <a href="{% url 'beadmodels:create' %}?model_id={{ model.id }}" class="btn btn-light btn-sm shadow-sm rounded-pill" title="{% trans 'Régénérer le motif' %}"><i class="bi bi-arrow-repeat me-1"></i> {% trans 'Régénérer' %}</a>
          </div>
        {% endif %}
      </div>
    {% else %}
      <div class="empty-pattern">
        <i class="bi bi-grid-3x3-gap" style="font-size: 3rem;"></i>
        <p class="mt-2 mb-3">
          {% trans 'Pas encore de motif' %}
        </p>
        {% if user == model.creator %}
          <a href="{% url 'beadmodels:create' %}?model_id={{ model.id }}" class="btn btn-primary rounded-pill btn-sm"><i class="bi bi-magic me-1"></i> {% trans 'Générer' %}</a>
        {% endif %}
      </div>
    {% endif %}

    {# === RIGHT: Info panel === #}
    <div class="info-panel">
      {# Title #}
      <div>
        {% if user == model.creator %}
          <div id="inline-name">
            <h6 class="editable-field d-inline-flex align-items-center gap-1 mb-0" hx-get="{% url 'beadmodels:inline_edit' model.pk 'name' %}" hx-target="#inline-name" hx-swap="innerHTML" role="button" title="{% trans 'Cliquer pour modifier' %}">
              {{ model.name }}
              <i class="bi bi-pencil text-muted edit-icon" style="font-size:.55em;"></i>
            </h6>
          </div>
        {% else %}
          <h6 class="mb-0">{{ model.name }}</h6>
        {% endif %}

        {# Description #}
        {% if user == model.creator %}
          <div id="inline-description" class="mt-1">
            {% if model.description %}
              <small class="editable-field d-inline-flex align-items-center gap-1 text-secondary" hx-get="{% url 'beadmodels:inline_edit' model.pk 'description' %}" hx-target="#inline-description" hx-swap="innerHTML" role="button">
                {{ model.description }}
                <i class="bi bi-pencil text-muted edit-icon" style="font-size:.7em;"></i>
              </small>
            {% else %}
              <small class="editable-field text-muted d-inline-flex align-items-center gap-1" hx-get="{% url 'beadmodels:inline_edit' model.pk 'description' %}" hx-target="#inline-description" hx-swap="innerHTML" role="button"><i class="bi bi-pencil" style="font-size:.7em;"></i> {% trans 'Description…' %}</small>
            {% endif %}
          </div>
        {% else %}
          {% if model.description %}
            <small class="text-secondary">{{ model.description }}</small>
          {% endif %}
        {% endif %}
      </div>

      {# Meta #}
      <div class="meta-line">
        <span><i class="bi bi-person"></i> {{ model.creator.username }}</span>
        <span><i class="bi bi-calendar3"></i> {{ model.created_at|date:'d/m/Y' }}</span>
        {% if model.is_public %}
          <span class="badge bg-success-subtle text-success" style="font-size:.75rem;">{% trans 'Public' %}</span>
        {% else %}
          <span class="badge bg-secondary-subtle text-secondary" style="font-size:.75rem;">{% trans 'Privé' %}</span>
        {% endif %}
      </div>

      <hr class="my-0" />

      {# Download #}
      {% if model.bead_pattern %}
        <div class="dl-strip">
          <a href="{% url 'beadmodels:download' model.pk 'pdf' %}" class="btn btn-primary btn-sm rounded-pill"><i class="bi bi-download me-1"></i> PDF</a>
          <a href="{% url 'beadmodels:download' model.pk 'png' %}" class="btn btn-outline-secondary btn-sm rounded-pill"><i class="bi bi-image me-1"></i> PNG</a>
        </div>
      {% endif %}

      {# Stats #}
      {% if model.metadata.total_beads or model.metadata.grid_width %}
        <div>
          <div class="section-lbl">
            {% trans 'Statistiques' %}
          </div>
          <div class="d-flex flex-wrap gap-1">
            {% if model.metadata.grid_width %}
              <div class="stat-chip">
                <strong>{{ model.metadata.grid_width }}×{{ model.metadata.grid_height }}</strong> <span>{% trans 'grille' %}</span>
              </div>
            {% endif %}
            {% if model.metadata.total_beads %}
              <div class="stat-chip">
                <strong>{{ model.metadata.total_beads }}</strong> <span>{% trans 'perles' %}</span>
              </div>
            {% endif %}
            {% if model.metadata.palette %}
              <div class="stat-chip">
                <strong>{{ model.metadata.palette|length }}</strong> <span>{% trans 'couleurs' %}</span>
              </div>
            {% endif %}
          </div>
          {% if model.board %}
            <div class="mt-1" style="font-size:.72rem; color:#adb5bd;">
              <i class="bi bi-grid"></i> {{ model.board.name }} ({{ model.board.width_pegs }}×{{ model.board.height_pegs }})
            </div>
          {% endif %}
        </div>
      {% endif %}

      {# Palette #}
      {% if model.metadata.palette %}
        <div>
          <div class="section-lbl">
            {% trans 'Palette' %}
          </div>
          <div class="d-flex flex-wrap gap-1">
            {% for color in model.metadata.palette %}
              {% if not color.is_background %}
                <span class="swatch" style="background-color: {{ color.hex }};" title="{% blocktrans with hex=color.hex count=color.count pct=color.percentage %}{{ hex }} — {{ count }} perles ({{ pct }}%){% endblocktrans %}" data-bs-toggle="tooltip"></span>
              {% endif %}
            {% endfor %}
          </div>
        </div>
      {% endif %}

      {# Original image #}
      <div class="d-flex align-items-center gap-2">
        <div class="original-wrap">
          <img src="{{ model.original_image.url }}" class="original-thumb" alt="{% trans 'Originale' %}" />
          <img src="{{ model.original_image.url }}" class="original-zoom" alt="{% trans "Aperçu de l'image originale" %}" />
        </div>
        <div>
          <div class="section-lbl mb-0">
            {% trans 'Image originale' %}
          </div>
          <div style="font-size:.75rem; color:#adb5bd;">
            {% trans 'Survoler pour agrandir' %}
          </div>
        </div>
      </div>

      {# Spacer + delete at bottom #}
      <div class="mt-auto"></div>
      {% if user == model.creator %}
        <button type="button" class="btn btn-sm btn-outline-danger w-100" style="font-size:.78rem;" data-bs-toggle="modal" data-bs-target="#deleteModal"><i class="bi bi-trash me-1"></i> {% trans 'Supprimer' %}</button>
      {% endif %}
    </div>
  </div>

  {# Delete confirmation modal #}
  {% if user == model.creator %}
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-dialog-centered modal-sm">
        <div class="modal-content">
          <div class="modal-header border-0 pb-0">
            <h6 class="modal-title" id="deleteModalLabel">{% trans 'Supprimer ce modèle ?' %}</h6>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="{% trans 'Fermer' %}"></button>
          </div>
          <div class="modal-body pt-2">
            <p class="text-secondary mb-0" style="font-size:.88rem;">
              {% blocktrans with name=model.name %}Le modèle <strong>« {{ name }} »</strong> sera supprimé définitivement.{% endblocktrans %}
            </p>
          </div>
          <div class="modal-footer border-0 pt-0">
            <button type="button" class="btn btn-sm btn-secondary rounded-pill" data-bs-dismiss="modal">{% trans 'Annuler' %}</button>
            <form method="post" action="{% url 'beadmodels:delete' model.pk %}">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-danger rounded-pill"><i class="bi bi-trash me-1"></i> {% trans 'Supprimer' %}</button>
            </form>
          </div>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block extra_js %}
  <script>
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function (el) {
      new bootstrap.Tooltip(el)
    })
  </script>
{% endblock %}
