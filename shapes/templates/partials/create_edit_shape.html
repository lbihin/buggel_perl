{% load crispy_forms_tags %}

<div class="card mb-4 shape-form">
  <div class="card-header bg-light">
    <h5 class="mb-0">{% if shape %}Modifier{% else %}Ajouter{% endif %} une forme</h5>
  </div>
  <div class="card-body">
    <form id="shapeForm" 
          hx-post="{% if shape %}{% url 'shapes:shape_update_hx' shape.id %}{% else %}{% url 'shapes:shape_create_hx' %}{% endif %}"
          hx-swap="outerHTML"
          hx-target="#shape-form-container">
      {% csrf_token %}
      
      <div class="mb-3">
        <label for="id_name" class="form-label">Nom</label>
        <input type="text" class="form-control" id="id_name" name="name" value="{{ shape.name|default:'' }}" required>
      </div>

      <div class="mb-3">
        <label class="form-label">Type de forme</label>
        <div class="bg-light p-2 rounded">
          <span id="auto_type_label" class="fw-bold">
            {% if shape %}
              {% if shape.shape_type == 'rectangle' %}Rectangle
              {% elif shape.shape_type == 'square' %}Carré
              {% elif shape.shape_type == 'circle' %}Cercle
              {% endif %}
            {% else %}
              Sera déterminé automatiquement
            {% endif %}
          </span>
          <small class="text-muted ms-2">(déterminé par les dimensions)</small>
        </div>
        <!-- Champ caché pour compatibilité -->
        <input type="hidden" id="id_shape_type" name="shape_type" value="{{ shape.shape_type|default:'rectangle' }}">
      </div>
      
      <div class="mb-3">
        <label class="form-label">Dimensions</label>
        <div class="border rounded p-3">
          <div class="mb-3">
            <label class="form-check-label">
              <input type="radio" name="dimension_type" value="rectangle" class="form-check-input dimension-selector" 
                     {% if shape.shape_type == 'rectangle' or not shape %}checked{% endif %}>
              Rectangle
            </label>
            <div class="dimension-fields rectangle-fields mt-2 ms-4 {% if shape.shape_type != 'rectangle' and shape %}d-none{% endif %}">
              <div class="row">
                <div class="col-md-6">
                  <label for="id_width" class="form-label">Largeur</label>
                  <input type="number" class="form-control" id="id_width" name="width" min="1" value="{{ shape.width|default:'10' }}">
                </div>
                <div class="col-md-6">
                  <label for="id_height" class="form-label">Hauteur</label>
                  <input type="number" class="form-control" id="id_height" name="height" min="1" value="{{ shape.height|default:'10' }}">
                </div>
              </div>
            </div>
          </div>
          
          <div class="mb-3">
            <label class="form-check-label">
              <input type="radio" name="dimension_type" value="square" class="form-check-input dimension-selector"
                     {% if shape.shape_type == 'square' %}checked{% endif %}>
              Carré
            </label>
            <div class="dimension-fields square-fields mt-2 ms-4 {% if shape.shape_type != 'square' %}d-none{% endif %}">
              <label for="id_size" class="form-label">Taille</label>
              <input type="number" class="form-control" id="id_size" name="size" min="1" value="{{ shape.size|default:'10' }}">
            </div>
          </div>
          
          <div>
            <label class="form-check-label">
              <input type="radio" name="dimension_type" value="circle" class="form-check-input dimension-selector"
                     {% if shape.shape_type == 'circle' %}checked{% endif %}>
              Cercle
            </label>
            <div class="dimension-fields circle-fields mt-2 ms-4 {% if shape.shape_type != 'circle' %}d-none{% endif %}">
              <label for="id_diameter" class="form-label">Diamètre</label>
              <input type="number" class="form-control" id="id_diameter" name="diameter" min="1" value="{{ shape.diameter|default:'10' }}">
            </div>
          </div>
        </div>
      </div>
      
      <!-- Option de partage -->
      <div class="mb-3 form-check">
        <input type="checkbox" class="form-check-input" id="id_share_shape" name="share_shape" {% if shape.is_shared %}checked{% endif %}>
        <label class="form-check-label" for="id_share_shape">Partager cette forme avec les autres utilisateurs</label>
      </div>
      
      <!-- Aperçu de la forme -->
      <div class="shape-preview-container mb-4">
        <h6 class="mb-2">Aperçu</h6>
        <div class="shape-preview bg-light border rounded d-flex align-items-center justify-content-center p-3">
          <canvas id="previewCanvas" width="200" height="200"></canvas>
        </div>
      </div>
      
      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">
          <span class="htmx-indicator spinner-border spinner-border-sm me-1" role="status" aria-hidden="true"></span>
          {% if shape %}Modifier{% else %}Ajouter{% endif %}
        </button>
        <button type="button" class="btn btn-secondary cancel-form-btn" hx-get="{% url 'shapes:shape_list' %}" hx-target="#shape-{{ shape.id|default:'new' }}" hx-swap="outerHTML">Annuler</button>
      </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const shapeTypeHidden = document.getElementById('id_shape_type');
  const dimensionSelectors = document.querySelectorAll('.dimension-selector');
  const dimensionFields = document.querySelectorAll('.dimension-fields');
  const autoTypeLabel = document.getElementById('auto_type_label');
  const previewCanvas = document.getElementById('previewCanvas');
  
  // Gestion des sélecteurs de dimension
  dimensionSelectors.forEach(selector => {
    selector.addEventListener('change', function() {
      // Cacher tous les champs de dimensions
      dimensionFields.forEach(field => field.classList.add('d-none'));
      
      // Afficher uniquement les champs correspondants au type sélectionné
      const selectedType = this.value;
      const fieldsToShow = document.querySelector(`.${selectedType}-fields`);
      if (fieldsToShow) {
        fieldsToShow.classList.remove('d-none');
      }
      
      // Mettre à jour le type automatique
      updateAutoTypeLabel(selectedType);
      
      // Mettre à jour le champ caché pour la compatibilité
      shapeTypeHidden.value = selectedType;
      
      // Mettre à jour l'aperçu
      if (previewCanvas) {
        updateShapePreview();
      }
    });
  });
  
  function updateAutoTypeLabel(type) {
    let typeText = 'Sera déterminé automatiquement';
    if (type === 'rectangle') typeText = 'Rectangle';
    else if (type === 'square') typeText = 'Carré';
    else if (type === 'circle') typeText = 'Cercle';
    
    autoTypeLabel.textContent = typeText;
  }
  
  // Veiller à ce que le canvas existe (il pourrait ne pas être rendu dans certains cas)
  if (previewCanvas) {
    const ctx = previewCanvas.getContext('2d');
    
    // Mise à jour lorsque les dimensions changent
    ['id_width', 'id_height', 'id_size', 'id_diameter'].forEach(fieldId => {
      const field = document.getElementById(fieldId);
      if (field) {
        field.addEventListener('input', updateShapePreview);
      }
    });
    
    // Mise à jour initiale
    updateShapePreview();
    
    function updateShapePreview() {
      // ...existing code...
      // Cette fonction devrait être remplacée par votre code d'aperçu existant
    }
  }
});
</script>
