{% extends 'base.html' %}
{% load static %}

{% block extra_head %}
  <link rel="stylesheet" href="{% static 'css/wizard.css' %}" />
  <link rel="stylesheet" href="{% static 'css/custom_wizard.css' %}" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.css">
  <style>
    /* Styles améliorés pour la page de sauvegarde */
    .save-form-container {
      background-color: #f8f9fa;
      border-radius: 12px;
      padding: 25px;
      border: 1px solid #dee2e6;
      margin-bottom: 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .palette-container {
      max-height: 350px;
      overflow-y: auto;
      border-radius: 8px;
      padding: 15px;
      background-color: white;
      border: 1px solid #e9ecef;
    }
    
    .pixelized-image {
      max-width: 100%;
      height: auto;
      border: 2px solid #ddd;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      transition: transform 0.3s ease;
    }
    
    .pixelized-image:hover {
      transform: scale(1.02);
    }
    
    .color-sample {
      width: 25px;
      height: 25px;
      display: inline-block;
      border: 1px solid #ddd;
      vertical-align: middle;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    
    .form-buttons {
      margin-top: 25px;
    }
    
    .details-section {
      margin-top: 25px;
    }
    
    .model-card {
      border-radius: 10px;
      transition: all 0.3s ease;
      box-shadow: 0 5px 15px rgba(0,0,0,0.08);
      overflow: hidden;
    }
    
    .model-preview {
      padding: 15px;
      background: linear-gradient(to bottom right, #f8f9fa, #e9ecef);
      border-bottom: 1px solid #dee2e6;
    }
    
    .model-title {
      font-size: 1.5rem;
      margin-bottom: 10px;
      color: #495057;
    }
    
    .color-match {
      padding: 8px;
      border-radius: 6px;
      margin-top: 5px;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
    }
    
    .color-match-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
    
    .match-item {
      display: flex;
      align-items: center;
      margin-bottom: 3px;
    }
    
    .match-color {
      width: 20px;
      height: 20px;
      border-radius: 3px;
      margin-right: 8px;
      border: 1px solid #ddd;
    }
    
    .download-options {
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .model-info {
      background-color: #e9ecef;
      padding: 10px 15px;
      border-radius: 6px;
      margin: 15px 0;
    }
    
    .info-badge {
      font-size: 0.9rem;
      padding: 5px 10px;
      margin-right: 5px;
    }
    
    .board-preview {
      margin-top: 15px;
      text-align: center;
    }
    
    .board-preview img {
      max-width: 150px;
      border-radius: 5px;
      border: 1px solid #dee2e6;
    }
    
    .bootstrap-tagsinput {
      width: 100%;
      padding: 8px 12px;
      border-radius: 4px;
    }
    
    .tab-content {
      padding: 20px 0;
    }
    
    .nav-tabs .nav-link {
      border-radius: 8px 8px 0 0;
    }
    
    .nav-tabs .nav-link.active {
      font-weight: bold;
    }
    
    /* Animation pour les succès */
    @keyframes highlight {
      0% { background-color: transparent; }
      30% { background-color: rgba(40, 167, 69, 0.2); }
      100% { background-color: transparent; }
    }
    
    .highlight {
      animation: highlight 2s ease;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="container mt-3 wizard-container">
    <h1 class="h3">{{ wizard.name }}</h1>
    
    <div class="progress mb-4">
      <div class="progress-bar bg-success" role="progressbar" style="width: {% widthratio wizard_step total_steps 100 %}%;" 
          aria-valuenow="{{ wizard_step }}" aria-valuemin="0" aria-valuemax="{{ total_steps }}">
        Étape {{ wizard_step }} sur {{ total_steps }}
      </div>
    </div>
    
    <div class="card wizard-card model-card">
      <div class="card-header bg-success text-white">
        <div class="d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Étape {{ wizard_step }} : {{ current_step.name }}</h5>
          <span class="badge bg-light text-dark">Étape {{ wizard_step }} sur {{ total_steps }}</span>
        </div>
      </div>
      <div class="card-body">
        <!-- Onglets pour une meilleure organisation -->
        <ul class="nav nav-tabs" id="myTab" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="save-tab" data-bs-toggle="tab" data-bs-target="#save" type="button" role="tab" aria-controls="save" aria-selected="true">
              <i class="bi bi-save"></i> Sauvegarder
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="preview-tab" data-bs-toggle="tab" data-bs-target="#preview" type="button" role="tab" aria-controls="preview" aria-selected="false">
              <i class="bi bi-eye"></i> Prévisualisation
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="palette-tab" data-bs-toggle="tab" data-bs-target="#palette" type="button" role="tab" aria-controls="palette" aria-selected="false">
              <i class="bi bi-palette"></i> Palette
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="export-tab" data-bs-toggle="tab" data-bs-target="#export" type="button" role="tab" aria-controls="export" aria-selected="false">
              <i class="bi bi-download"></i> Export
            </button>
          </li>
        </ul>
        
        <div class="tab-content" id="myTabContent">
          <!-- Onglet Sauvegarder -->
          <div class="tab-pane fade show active" id="save" role="tabpanel" aria-labelledby="save-tab">
            <div class="row">
              <!-- Colonne de gauche avec l'aperçu -->
              <div class="col-md-5">
                <div class="model-preview">
                  <h5 id="model-preview-title" class="model-title">{{ form.name.value }}</h5>
                  
                  <div class="image-container text-center mb-3">
                    {% if image_base64 %}
                      <div class="pixelized-preview-container">
                        <div class="grid-view">
                          <img src="data:image/png;base64,{{ image_base64 }}" alt="Modèle final" class="pixelized-image img-fluid" />
                        </div>
                      </div>
                    {% else %}
                      <div class="alert alert-warning">
                        Aucune image générée. <a href="{% url 'beadmodels:model_creation_wizard' %}?reset=true">Retour à l'étape 1</a>.
                      </div>
                    {% endif %}
                  </div>
                  
                  <div class="model-info">
                    <div class="d-flex justify-content-center flex-wrap">
                      <span class="badge bg-primary info-badge">
                        <i class="bi bi-grid-3x3"></i> {{ grid_width }}×{{ grid_height }}
                      </span>
                      <span class="badge bg-secondary info-badge">
                        <i class="bi bi-circle-fill"></i> {{ total_beads }} perles
                      </span>
                      <span class="badge bg-info info-badge">
                        <i class="bi bi-palette"></i> {{ beads_count }} couleurs
                      </span>
                      {% if shape_name != "Standard" %}
                        <span class="badge bg-success info-badge">
                          <i class="bi bi-shape"></i> {{ shape_name }}
                        </span>
                      {% endif %}
                    </div>
                  </div>
                  
                  <!-- Preview du support sélectionné -->
                  <div id="board-preview" class="board-preview">
                    <small class="text-muted">Support sélectionné:</small>
                    <h6>{{ default_board.name }}</h6>
                    {% if board_preview_url %}
                      <img src="{{ board_preview_url }}" alt="Aperçu du support" class="img-fluid" />
                    {% endif %}
                  </div>
                </div>
              </div>
              
              <!-- Colonne de droite avec le formulaire -->
              <div class="col-md-7">
                <div class="save-form-container">
                  <h5>Informations du modèle</h5>
                  <form method="post" class="mt-3">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                      <label for="{{ form.name.id_for_label }}" class="form-label">Nom du modèle</label>
                      {{ form.name }}
                      {% if form.name.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.name.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                      {% endif %}
                    </div>
                    
                    <div class="mb-3">
                      <label for="{{ form.description.id_for_label }}" class="form-label">Description (optionnelle)</label>
                      {{ form.description }}
                      {% if form.description.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.description.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                      {% endif %}
                    </div>
                    
                    <div class="mb-3">
                      <label for="{{ form.board.id_for_label }}" class="form-label">Support de perles</label>
                      {{ form.board }}
                      {% if form.board.errors %}
                      <div class="invalid-feedback d-block">
                        {% for error in form.board.errors %}
                          {{ error }}
                        {% endfor %}
                      </div>
                      {% endif %}
                    </div>
                    
                    <!-- Champs supplémentaires -->
                    <div class="mb-3">
                      <label for="{{ form.tags.id_for_label }}" class="form-label">Tags</label>
                      {{ form.tags }}
                      <div class="form-text">{{ form.tags.help_text }}</div>
                    </div>
                    
                    <!-- Options avancées avec accordéon -->
                    <div class="accordion mb-3" id="optionsAccordion">
                      <div class="accordion-item">
                        <h2 class="accordion-header" id="optionsHeading">
                          <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#optionsCollapse">
                            Options avancées
                          </button>
                        </h2>
                        <div id="optionsCollapse" class="accordion-collapse collapse" aria-labelledby="optionsHeading" data-bs-parent="#optionsAccordion">
                          <div class="accordion-body">
                            <div class="form-check mb-2">
                              {{ form.is_public }}
                              <label class="form-check-label" for="{{ form.is_public.id_for_label }}">
                                Rendre ce modèle public
                              </label>
                              <div class="form-text">{{ form.is_public.help_text }}</div>
                            </div>
                            
                            <div class="form-check">
                              {{ form.favorite }}
                              <label class="form-check-label" for="{{ form.favorite.id_for_label }}">
                                Ajouter aux favoris
                              </label>
                              <div class="form-text">{{ form.favorite.help_text }}</div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                    
                    <div class="d-grid gap-2">
                      <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-save"></i> Sauvegarder le modèle
                      </button>
                      
                      <div class="btn-group">
                        <a href="javascript:history.back();" class="btn btn-outline-secondary">
                          <i class="bi bi-arrow-left-circle"></i> Retour
                        </a>
                        <a href="{% url 'beadmodels:model_creation_wizard' %}?reset=true" class="btn btn-outline-info">
                          <i class="bi bi-arrow-clockwise"></i> Nouveau modèle
                        </a>
                      </div>
                    </div>
                  </form>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Onglet Prévisualisation -->
          <div class="tab-pane fade" id="preview" role="tabpanel" aria-labelledby="preview-tab">
            <div class="row">
              <div class="col-md-8 offset-md-2 text-center">
                <h5>Prévisualisation du modèle</h5>
                
                {% if image_base64 %}
                  <div class="pixelized-preview-container mb-4">
                    <img src="data:image/png;base64,{{ image_base64 }}" alt="Modèle final" class="pixelized-image img-fluid" />
                  </div>
                  
                  <div class="model-info mb-4">
                    <div class="row">
                      <div class="col">
                        <div class="card h-100">
                          <div class="card-body">
                            <h6 class="card-title">Dimensions</h6>
                            <p class="card-text">{{ grid_width }}×{{ grid_height }} perles</p>
                          </div>
                        </div>
                      </div>
                      <div class="col">
                        <div class="card h-100">
                          <div class="card-body">
                            <h6 class="card-title">Total de perles</h6>
                            <p class="card-text">{{ total_beads }} perles</p>
                          </div>
                        </div>
                      </div>
                      <div class="col">
                        <div class="card h-100">
                          <div class="card-body">
                            <h6 class="card-title">Palette</h6>
                            <p class="card-text">{{ beads_count }} couleurs</p>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                {% else %}
                  <div class="alert alert-warning">
                    Aucune image générée.
                  </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- Onglet Palette -->
          <div class="tab-pane fade" id="palette" role="tabpanel" aria-labelledby="palette-tab">
            <div class="row">
              <div class="col-md-8 offset-md-2">
                <h5>Palette de couleurs</h5>
                <div class="palette-container">
                  <div class="table-responsive">
                    <table class="table table-hover">
                      <thead>
                        <tr>
                          <th>Couleur</th>
                          <th>Quantité</th>
                          <th>%</th>
                          {% if user_has_beads %}
                          <th>Correspondances</th>
                          {% endif %}
                        </tr>
                      </thead>
                      <tbody>
                        {% for color in palette %}
                          <tr>
                            <td>
                              <span class="color-sample" style="background-color: {{ color.color }};"></span>
                              <small>{{ color.hex }}</small>
                            </td>
                            <td>{{ color.count }}</td>
                            <td>{{ color.percentage }}%</td>
                            {% if user_has_beads %}
                            <td>
                              {% if color.matches %}
                                <div class="color-match">
                                  <div class="color-match-title">Perles similaires:</div>
                                  {% for match in color.matches %}
                                    <div class="match-item">
                                      <span class="match-color" style="background-color: {{ match.color }};"></span>
                                      <span>{{ match.name }} 
                                        <small class="text-muted">({{ match.distance }} pts)</small>
                                        {% if match.quantity %}
                                          <span class="badge bg-success">{{ match.quantity }} disponibles</span>
                                        {% endif %}
                                      </span>
                                    </div>
                                  {% endfor %}
                                </div>
                              {% else %}
                                <span class="text-muted">Aucune correspondance</span>
                              {% endif %}
                            </td>
                            {% endif %}
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
                
                {% if not user_has_beads %}
                <div class="alert alert-info mt-3">
                  <i class="bi bi-info-circle"></i> Vous n'avez pas encore ajouté de perles à votre collection.
                  <a href="{% url 'beadmodels:bead_create' %}" class="alert-link">Ajouter des perles</a> pour voir les correspondances.
                </div>
                {% endif %}
              </div>
            </div>
          </div>
          
          <!-- Onglet Export -->
          <div class="tab-pane fade" id="export" role="tabpanel" aria-labelledby="export-tab">
            <div class="row">
              <div class="col-md-6 offset-md-3">
                <h5 class="mb-4">Exporter votre modèle</h5>
                
                <div class="download-options">
                  <h6>Télécharger l'image</h6>
                  <p>Téléchargez l'image du modèle dans différents formats</p>
                  
                  <form method="post" class="row g-2">
                    {% csrf_token %}
                    <div class="col-8">
                      <select name="download_format" class="form-select">
                        <option value="png">PNG (avec transparence)</option>
                        <option value="jpg">JPG (meilleure compatibilité)</option>
                        <option value="pdf">PDF (document)</option>
                      </select>
                    </div>
                    <div class="col-4">
                      <button type="submit" name="download" class="btn btn-success w-100">
                        <i class="bi bi-download"></i> Télécharger
                      </button>
                    </div>
                  </form>
                </div>
                
                <div class="download-options">
                  <h6>Générer des instructions</h6>
                  <p>Créez une fiche d'instructions pour réaliser ce modèle</p>
                  
                  <form method="post">
                    {% csrf_token %}
                    <button type="submit" name="download_instructions" class="btn btn-primary">
                      <i class="bi bi-file-earmark-text"></i> Générer les instructions
                    </button>
                  </form>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-tagsinput/0.8.0/bootstrap-tagsinput.min.js"></script>
<script>
  // Initialiser les tags input
  $(document).ready(function() {
    $('input[data-role="tagsinput"]').tagsinput();
    
    // Mettre à jour le titre du modèle en temps réel
    $('#model-name-input').on('keyup', function() {
      $('#model-preview-title').text($(this).val());
    });
    
    // Mettre en surbrillance les éléments modifiés
    $('#model-name-input, #id_description').on('change', function() {
      $(this).addClass('highlight');
      setTimeout(() => {
        $(this).removeClass('highlight');
      }, 2000);
    });
    
    // Changer l'aperçu du support lorsque le support est modifié
    $('#id_board').on('change', function() {
      const boardId = $(this).val();
      $('#board-preview h6').text($('#id_board option:selected').text());
      $('#board-preview img').attr('src', `/media/board_previews/${boardId}.png`);
    });
  });
</script>
{% endblock %}