{% extends 'beadmodels/base.html' %}

{% block content %}
<div class="container mt-4">
  <h1>Assistant de pixelisation</h1>
  
  {% if wizard_step == 1 %}
  <div class="card">
    <div class="card-header bg-primary text-white">
      <div class="d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Étape 1 : Configuration du modèle</h5>
        <span class="badge bg-light text-dark">Étape {{ wizard_step }} sur 2</span>
      </div>
    </div>
    <div class="card-body">
      <p class="mb-3">Sélectionnez une image et configurez les paramètres pour créer votre modèle de perles.</p>
      
      <form method="post" enctype="multipart/form-data" class="needs-validation" novalidate>
        {% csrf_token %}
        
        <div class="row">
          <div class="col-md-6 mb-3">
            {% if model %}
              <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> Vous utilisez l'image du modèle "<strong>{{ model.name }}</strong>".
                <small>Vous pouvez télécharger une autre image pour remplacer celle-ci.</small>
              </div>
            {% endif %}
            
            <label for="{{ form.image.id_for_label }}" class="form-label">{{ form.image.label }}</label>
            {{ form.image }}
            <small class="form-text text-muted">{{ form.image.help_text }}</small>
          </div>
          
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label fw-bold">Aperçu de l'image</label>
              <div id="imagePreview" class="border rounded p-2 d-flex justify-content-center align-items-center" style="height: 200px; background-color: #f8f9fa;">
                {% if model and model.original_image %}
                  <img id="preview" src="{{ model.original_image.url }}" alt="Aperçu" style="max-width: 100%; max-height: 100%;">
                {% else %}
                  <span id="previewPlaceholder" class="text-muted">L'aperçu de l'image s'affichera ici</span>
                  <img id="preview" src="" alt="Aperçu" style="max-width: 100%; max-height: 100%; display: none;">
                {% endif %}
              </div>
            </div>
          </div>
        </div>
        
        <hr class="my-4">
        <h5 class="mb-3">Paramètres de la grille</h5>
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ form.grid_width.id_for_label }}" class="form-label">{{ form.grid_width.label }}</label>
            {{ form.grid_width }}
          </div>
          <div class="col-md-6 mb-3">
            <label for="{{ form.grid_height.id_for_label }}" class="form-label">{{ form.grid_height.label }}</label>
            {{ form.grid_height }}
          </div>
        </div>
        
        <hr class="my-4">
        <h5 class="mb-3">Paramètres des couleurs</h5>
        
        <div class="row">
          <div class="col-md-6 mb-3">
            <label for="{{ form.color_reduction.id_for_label }}" class="form-label">{{ form.color_reduction.label }}</label>
            {{ form.color_reduction }}
            <small class="form-text text-muted">{{ form.color_reduction.help_text }}</small>
          </div>
          
          <div class="col-md-6 mb-3">
            <div class="form-check mt-4">
              {{ form.use_available_colors }}
              <label class="form-check-label" for="{{ form.use_available_colors.id_for_label }}">
                {{ form.use_available_colors.label }}
              </label>
              <small class="d-block form-text text-muted">{{ form.use_available_colors.help_text }}</small>
            </div>
          </div>
        </div>
        
        <div class="d-flex justify-content-between mt-4">
          <button type="submit" name="cancel_wizard" class="btn btn-secondary">
            <i class="bi bi-x-circle"></i> Quitter le wizard
          </button>
          
          <button type="submit" class="btn btn-primary">
            Suivant <i class="bi bi-arrow-right"></i>
          </button>
        </div>
      </form>
    </div>
  </div>
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Gestion de l'aperçu de l'image
    const imageInput = document.getElementById('{{ form.image.id_for_label }}');
    const preview = document.getElementById('preview');
    const previewPlaceholder = document.getElementById('previewPlaceholder');
    
    if (imageInput) {
      imageInput.addEventListener('change', function() {
        if (this.files && this.files[0]) {
          const reader = new FileReader();
          
          reader.onload = function(e) {
            preview.src = e.target.result;
            preview.style.display = 'block';
            if (previewPlaceholder) {
              previewPlaceholder.style.display = 'none';
            }
          };
          
          reader.readAsDataURL(this.files[0]);
        }
      });
    }
    
    // Gestion du bouton "Quitter le wizard"
    const cancelButton = document.querySelector('button[name="cancel_wizard"]');
    if (cancelButton) {
      cancelButton.addEventListener('click', function(event) {
        if (!confirm('Êtes-vous sûr de vouloir quitter le wizard? Les modifications non enregistrées seront perdues.')) {
          event.preventDefault();
        }
      });
    }
    
    // Validation du formulaire
    const form = document.querySelector('form');
    if (form) {
      form.addEventListener('submit', function(event) {
        // Ne pas vérifier la présence d'une image si on quitte le wizard
        if (event.submitter && event.submitter.name === 'cancel_wizard') {
          return true;
        }
        
        // Vérifier si une image est sélectionnée OU si nous avons un modèle avec une image
        const hasModelImage = document.getElementById('preview').src !== '';
        if (!hasModelImage && (!imageInput.files || !imageInput.files[0])) {
          event.preventDefault();
          alert('Veuillez sélectionner une image.');
          return false;
        }
      });
    }
  });
</script>
{% endblock %}
