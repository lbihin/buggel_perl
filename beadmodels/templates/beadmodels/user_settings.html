{% extends 'beadmodels/base.html' %}
{% load crispy_forms_tags %}
{% load static %}

{% block extra_head %}
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/themes/classic.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/@simonwep/pickr/dist/pickr.min.js"></script>
{% endblock %}

{% block content %}
  {% csrf_token %}
  <div class="settings-container">
    <!-- Menu latéral -->
    <div class="settings-sidebar">
      <nav class="settings-nav">
        <div class="nav flex-column nav-pills">
          <div class="nav-section">
            <small class="text-muted px-3 mb-2 d-block">Compte</small>
            <a class="nav-link {% if active_tab == 'profile' %}active{% endif %}" href="{% url 'beadmodels:user_settings' %}?tab=profile"><i class="bi bi-person"></i> Profil</a>
            <a class="nav-link {% if active_tab == 'password' %}active{% endif %}" href="{% url 'beadmodels:user_settings' %}?tab=password"><i class="bi bi-key"></i> Mot de passe</a>
          </div>

          <div class="settings-divider"></div>

          <div class="nav-section">
            <small class="text-muted px-3 mb-2 d-block">Formes</small>
            <a class="nav-link {% if active_tab == 'shapes' %}active{% endif %}" href="{% url 'beadmodels:user_settings' %}?tab=shapes"><i class="bi bi-grid"></i> Mes formes</a>
          </div>

          <div class="settings-divider"></div>

          <div class="nav-section">
            <small class="text-muted px-3 mb-2 d-block">Perles</small>
            <a class="nav-link {% if active_tab == 'beads' %}active{% endif %}" href="{% url 'beadmodels:user_settings' %}?tab=beads"><i class="bi bi-palette"></i> Mes perles</a>
          </div>

          <div class="settings-divider"></div>

          <div class="nav-section">
            <small class="text-muted px-3 mb-2 d-block">Application</small>
            <a class="nav-link {% if active_tab == 'preferences' %}active{% endif %}" href="{% url 'beadmodels:user_settings' %}?tab=preferences"><i class="bi bi-gear"></i> Préférences</a>
          </div>
        </div>
      </nav>
    </div>

    <!-- Contenu principal -->
    <div class="settings-content">
      <div class="settings-section">
        {% if messages %}
          <div class="messages">
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert" data-auto-dismiss="{{ message.tags }}">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
              </div>
            {% endfor %}
          </div>
        {% endif %}

        <script>
          // Faire disparaître automatiquement les messages de succès après 5 secondes
          document.addEventListener('DOMContentLoaded', function () {
            const successAlerts = document.querySelectorAll('.alert-success[data-auto-dismiss="success"]')
            successAlerts.forEach(function (alert) {
              setTimeout(function () {
                const bsAlert = new bootstrap.Alert(alert)
                bsAlert.close()
              }, 5000)
            })
          })
        </script>

        {% if active_tab == 'profile' %}
          <h2>Profil</h2>
          <form method="post" action="?tab=profile">
            {% csrf_token %}
            {{ form|crispy }}
            <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
          </form>
        {% elif active_tab == 'password' %}
          <h2>Changer le mot de passe</h2>
          <form method="post" action="?tab=password">
            {% csrf_token %}
            <div class="mb-3">
              <label for="current_password" class="form-label">Mot de passe actuel</label>
              <input type="password" class="form-control" id="current_password" name="current_password" required />
            </div>
            <div class="mb-3">
              <label for="new_password" class="form-label">Nouveau mot de passe</label>
              <input type="password" class="form-control" id="new_password" name="new_password" required />
            </div>
            <div class="mb-3">
              <label for="confirm_password" class="form-label">Confirmer le nouveau mot de passe</label>
              <input type="password" class="form-control" id="confirm_password" name="confirm_password" required />
            </div>
            <button type="submit" class="btn btn-primary">Changer le mot de passe</button>
          </form>
        {% elif active_tab == 'shapes' %}
          <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>Mes formes</h2>
            <a href="{% url 'beadmodels:create_shape' %}" class="btn btn-primary"><i class="bi bi-plus-circle"></i> Nouvelle forme</a>
          </div>

          <div class="row g-4" id="savedShapesList">
            {% for shape in saved_shapes %}
              <div class="col-md-6 col-lg-4">
                <div class="card h-100">
                  <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                      <h5 class="card-title mb-0">{{ shape.name }}</h5>
                      <div class="btn-group">
                        <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="Modifier la forme" onclick="window.location.href='{% url 'beadmodels:edit_shape' 0 %}'.replace('0', {{ shape.id }})"><i class="bi bi-pencil"></i></button>
                        <button type="button" class="btn btn-outline-danger btn-sm" data-bs-toggle="tooltip" data-bs-placement="top" title="Supprimer la forme" onclick="deleteShape({{ shape.id }})"><i class="bi bi-trash"></i></button>
                      </div>
                    </div>
                    <div class="shape-preview mb-3">
                      <div class="shape-canvas" id="canvas-{{ shape.id }}"></div>
                    </div>
                    <div class="shape-info">
                      <p class="card-text">
                        <small class="text-muted">
                          Type: {{ shape.get_shape_type_display }}<br />
                          Dimensions: {{ shape.get_dimensions_display }}<br />
                          Créé le: {{ shape.created_at|date:'d/m/Y H:i' }}
                        </small>
                      </p>
                    </div>
                  </div>
                </div>
              </div>
            {% empty %}
              <div class="col-12">
                <div class="text-center text-muted py-5">
                  <i class="bi bi-grid" style="font-size: 2rem;"></i>
                  <p class="mt-3">Vous n'avez pas encore de formes enregistrées.</p>
                </div>
              </div>
            {% endfor %}
          </div>

          <script>
            // Initialiser les tooltips
            document.addEventListener('DOMContentLoaded', function() {
              const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
              tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl)
              })
            })

            // Fonction pour modifier une forme
            function editShape(shapeId) {
              window.location.href = `{% url 'beadmodels:user_settings' %}?tab=shapes_new&edit=${shapeId}`
            }

            // Fonction pour supprimer une forme
            function deleteShape(shapeId) {
              if (confirm('Êtes-vous sûr de vouloir supprimer cette forme ?')) {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value
                
                fetch(`{% url 'beadmodels:delete_shape' 0 %}`.replace('0', shapeId), {
                  method: 'POST',
                  headers: {
                    'X-CSRFToken': csrfToken,
                    'X-Requested-With': 'XMLHttpRequest'
                  },
                  credentials: 'same-origin'
                })
                .then(response => response.json())
                .then(data => {
                  if (data.success) {
                    // Supprimer la carte de la forme
                    const shapeCard = document.querySelector(`.col-md-6:has(#canvas-${shapeId})`)
                    if (shapeCard) {
                      shapeCard.remove()
                    }
                    // Rediriger vers la page des formes pour afficher le message
                    window.location.href = '{% url "beadmodels:user_settings" %}?tab=shapes'
                  } else {
                    throw new Error(data.message || 'Une erreur est survenue lors de la suppression.')
                  }
                })
                .catch(error => {
                  // Rediriger vers la page des formes pour afficher l'erreur
                  window.location.href = '{% url "beadmodels:user_settings" %}?tab=shapes'
                })
              }
            }

            // Fonction pour afficher l'aperçu d'une forme
            function displayShapePreview(shape) {
              const canvas = document.getElementById(`canvas-${shape.id}`)
              const shapeType = shape.type
              const parameters = shape.parameters
              const maxSize = 200 // Taille maximale du canvas en pixels
              const pegSize = 4 // Taille des pics en pixels

              // Nettoyer le canvas
              canvas.innerHTML = ''

              switch (shapeType) {
                case 'rectangle': {
                  const width = parameters.width
                  const height = parameters.height
                  const spacing = Math.min(maxSize / width, maxSize / height)
                  const canvasWidth = width * spacing
                  const canvasHeight = height * spacing

                  canvas.style.width = `${canvasWidth}px`
                  canvas.style.height = `${canvasHeight}px`

                  for (let y = 0; y < height; y++) {
                    for (let x = 0; x < width; x++) {
                      const point = document.createElement('div')
                      point.className = 'peg-point'
                      point.style.width = `${pegSize}px`
                      point.style.height = `${pegSize}px`
                      point.style.left = `${x * spacing + (spacing - pegSize) / 2}px`
                      point.style.top = `${y * spacing + (spacing - pegSize) / 2}px`
                      canvas.appendChild(point)
                    }
                  }
                  break
                }
                case 'square': {
                  const size = parameters.size
                  const spacing = maxSize / size
                  const canvasSize = size * spacing

                  canvas.style.width = `${canvasSize}px`
                  canvas.style.height = `${canvasSize}px`

                  for (let y = 0; y < size; y++) {
                    for (let x = 0; x < size; x++) {
                      const point = document.createElement('div')
                      point.className = 'peg-point'
                      point.style.width = `${pegSize}px`
                      point.style.height = `${pegSize}px`
                      point.style.left = `${x * spacing + (spacing - pegSize) / 2}px`
                      point.style.top = `${y * spacing + (spacing - pegSize) / 2}px`
                      canvas.appendChild(point)
                    }
                  }
                  break
                }
                case 'circle': {
                  const diameter = parameters.diameter
                  const spacing = maxSize / diameter
                  const canvasSize = diameter * spacing
                  const radius = diameter / 2

                  canvas.style.width = `${canvasSize}px`
                  canvas.style.height = `${canvasSize}px`

                  for (let y = 0; y < diameter; y++) {
                    for (let x = 0; x < diameter; x++) {
                      const dx = x - radius + 0.5
                      const dy = y - radius + 0.5
                      const distance = Math.sqrt(dx * dx + dy * dy)

                      if (distance <= radius) {
                        const point = document.createElement('div')
                        point.className = 'peg-point'
                        point.style.width = `${pegSize}px`
                        point.style.height = `${pegSize}px`
                        point.style.left = `${x * spacing + (spacing - pegSize) / 2}px`
                        point.style.top = `${y * spacing + (spacing - pegSize) / 2}px`
                        canvas.appendChild(point)
                      }
                    }
                  }
                  break
                }
              }
            }

            // Afficher les aperçus des formes au chargement de la page
            document.addEventListener('DOMContentLoaded', function() {
              {% for shape in saved_shapes %}
                displayShapePreview({
                  id: {{ shape.id }},
                  type: '{{ shape.shape_type }}',
                  parameters: {{ shape.get_parameters|safe }}
                })
              {% endfor %}
            })
          </script>
        {% elif active_tab == 'shapes_new' %}
          <h2>Nouvelle forme</h2>
          <div id="shapeList" class="shape-list">
            <!-- Le template de forme sera ajouté ici -->
          </div>
        {% elif active_tab == 'preferences' %}
          <h2>Préférences</h2>
          <form method="post" action="?tab=preferences">
            {% csrf_token %}
            <div class="mb-3">
              <label class="form-label">Taille de grille par défaut</label>
              <select class="form-select" name="default_grid_size">
                <option value="16">16x16</option>
                <option value="24">24x24</option>
                <option value="32" selected>32x32</option>
                <option value="48">48x48</option>
                <option value="64">64x64</option>
              </select>
            </div>
            <div class="mb-3">
              <div class="form-check">
                <input class="form-check-input" type="checkbox" name="public_by_default" id="public_by_default" />
                <label class="form-check-label" for="public_by_default">Rendre les modèles publics par défaut</label>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">Enregistrer les préférences</button>
          </form>
        {% elif active_tab == 'beads' %}
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <h5 class="mb-0">Mes perles</h5>
              <button type="button" class="btn btn-primary" onclick="showBeadModal('Nouvelle perle')"><i class="bi bi-plus-circle"></i> Nouvelle perle</button>
            </div>
            <div class="card-body">
              <div class="row">
                {% regroup beads by color_category as color_sections %}
                {% for section in color_sections %}
                  <div class="col-12 mb-4">
                    <h6 class="text-muted mb-3">{{ section.grouper }}</h6>
                    <div class="row g-3">
                      {% for bead in section.list %}
                        <div class="col-md-4" data-bead-id="{{ bead.id }}" data-red="{{ bead.red }}" data-green="{{ bead.green }}" data-blue="{{ bead.blue }}" data-quantity="{{ bead.quantity }}" data-notes="{{ bead.notes|default:'' }}">
                          <div class="card h-100 bead-card">
                            <div class="card-body">
                              <div class="d-flex justify-content-between align-items-center mb-2">
                                <div class="color-preview" style="width: 100%; height: 30px; background-color: {{ bead.get_rgb_color }}; border-radius: 4px;"></div>
                                <span class="badge bg-primary ms-2">{{ bead.quantity }}</span>
                              </div>
                              {% if bead.notes %}
                                <p class="card-text text-muted small">{{ bead.notes }}</p>
                              {% endif %}
                              <div class="btn-group">
                                <button type="button" class="btn btn-sm btn-outline-primary" onclick="editBead({{ bead.id }})"><i class="bi bi-pencil"></i></button>
                                <button type="button" class="btn btn-sm btn-outline-danger" onclick="deleteBead({{ bead.id }})"><i class="bi bi-trash"></i></button>
                              </div>
                            </div>
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                  </div>
                {% empty %}
                  <div class="col-12">
                    <p class="text-center text-muted">Vous n'avez pas encore de perles.</p>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>

          <!-- Modal pour ajouter/modifier une perle -->
          <div class="modal fade" id="beadModal" tabindex="-1" data-bs-backdrop="static">
            <div class="modal-dialog">
              <div class="modal-content">
                <div class="modal-header">
                  <h5 class="modal-title" id="beadModalTitle">Nouvelle perle</h5>
                  <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                  <form id="beadForm">
                    <input type="hidden" id="beadId" />

                    <!-- Section Couleur -->
                    <div class="card mb-3">
                      <div class="card-header bg-light">
                        <h6 class="mb-0">Couleur de la perle</h6>
                      </div>
                      <div class="card-body">
                        <div class="mb-3">
                          <label for="colorPicker" class="form-label">Choisir une couleur</label>
                          <input type="color" id="colorPicker" class="form-control form-control-color" value="#000000" title="Choisir une couleur" style="width: 100%; height: 40px; padding: 0;" />
                        </div>
                      </div>
                    </div>

                    <!-- Section Quantité -->
                    <div class="card mb-3">
                      <div class="card-header bg-light">
                        <h6 class="mb-0">Quantité (optionnel)</h6>
                      </div>
                      <div class="card-body">
                        <div class="mb-3">
                          <label for="beadQuantity" class="form-label">Nombre de perles</label>
                          <input type="number" class="form-control" id="beadQuantity" min="0" />
                        </div>
                      </div>
                    </div>

                    <!-- Section Notes -->
                    <div class="card">
                      <div class="card-header bg-light">
                        <h6 class="mb-0">Notes (optionnel)</h6>
                      </div>
                      <div class="card-body">
                        <div class="mb-3">
                          <textarea class="form-control" id="beadNotes" rows="3" placeholder="Ajouter des notes sur cette perle..."></textarea>
                        </div>
                      </div>
                    </div>
                  </form>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                  <button type="button" class="btn btn-primary" onclick="saveBead()">Enregistrer</button>
                </div>
              </div>
            </div>
          </div>

          <script>
            function showBeadModal(title, beadId = null) {
              const modal = new bootstrap.Modal(document.getElementById('beadModal'));
              document.getElementById('beadModalTitle').textContent = title;
              document.getElementById('beadId').value = beadId || '';
              
              if (beadId) {
                // Charger les données de la perle
                const bead = document.querySelector(`[data-bead-id="${beadId}"]`);
                document.getElementById('beadQuantity').value = bead.dataset.quantity;
                document.getElementById('beadNotes').value = bead.dataset.notes || '';
                
                // Mettre à jour la couleur
                const colorPicker = document.getElementById('colorPicker');
                colorPicker.value = rgbToHex(parseInt(bead.dataset.red), parseInt(bead.dataset.green), parseInt(bead.dataset.blue));
              } else {
                // Réinitialiser le formulaire
                document.getElementById('beadForm').reset();
                const colorPicker = document.getElementById('colorPicker');
                colorPicker.value = '#000000';
              }
              
              modal.show();
            }

            // Fonction pour convertir RGB en HEX
            function rgbToHex(r, g, b) {
              return '#' + [r, g, b].map(x => {
                const hex = x.toString(16);
                return hex.length === 1 ? '0' + hex : hex;
              }).join('');
            }

            // Fonction pour convertir HEX en RGB
            function hexToRgb(hex) {
              const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
              return result ? {
                r: parseInt(result[1], 16),
                g: parseInt(result[2], 16),
                b: parseInt(result[3], 16)
              } : null;
            }

            function getColorName(red, green, blue) {
              // Couleurs de base
              if (red === 255 && green === 0 && blue === 0) return "Rouge";
              if (red === 0 && green === 255 && blue === 0) return "Vert";
              if (red === 0 && green === 0 && blue === 255) return "Bleu";
              if (red === 255 && green === 255 && blue === 0) return "Jaune";
              if (red === 255 && green === 0 && blue === 255) return "Magenta";
              if (red === 0 && green === 255 && blue === 255) return "Cyan";
              if (red === 255 && green === 255 && blue === 255) return "Blanc";
              if (red === 0 && green === 0 && blue === 0) return "Noir";
              if (red === 128 && green === 128 && blue === 128) return "Gris";
              if (red === 255 && green === 165 && blue === 0) return "Orange";
              if (red === 165 && green === 42 && blue === 42) return "Marron";
              if (red === 255 && green === 192 && blue === 203) return "Rose";
              if (red === 128 && green === 0 && blue === 128) return "Violet";
              
              // Pour les autres couleurs, on utilise une description basée sur les composantes
              let name = "";
              if (red > 200) name += "Rouge ";
              if (green > 200) name += "Vert ";
              if (blue > 200) name += "Bleu ";
              
              if (name === "") {
                  if (red > 100) name += "Rouge ";
                  if (green > 100) name += "Vert ";
                  if (blue > 100) name += "Bleu ";
              }
              
              if (name === "") {
                  if (red > 50) name += "Rouge ";
                  if (green > 50) name += "Vert ";
                  if (blue > 50) name += "Bleu ";
              }
              
              if (name === "") return "Gris foncé";
              
              name = name.trim() + (red + green + blue > 500 ? " clair" : " foncé");
              return name;
            }

            function saveBead() {
              const beadId = document.getElementById('beadId').value;
              const colorPicker = document.getElementById('colorPicker');
              const rgb = hexToRgb(colorPicker.value);
              
              const data = {
                action: beadId ? 'update' : 'add',
                bead_id: beadId,
                name: getColorName(rgb.r, rgb.g, rgb.b),
                red: rgb.r,
                green: rgb.g,
                blue: rgb.b,
                quantity: document.getElementById('beadQuantity').value || 0,
                notes: document.getElementById('beadNotes').value
              };

              fetch('{% url "beadmodels:user_settings" %}?tab=beads', {
                method: 'POST',
                headers: {
                  'Content-Type': 'application/json',
                  'X-CSRFToken': CSRF_TOKEN,
                  'X-Requested-With': 'XMLHttpRequest'
                },
                body: JSON.stringify(data)
              })
              .then(response => response.json())
              .then(data => {
                if (data.success) {
                  location.reload();
                } else {
                  alert('Erreur: ' + data.message);
                }
              })
              .catch(error => {
                console.error('Erreur:', error);
                alert('Une erreur est survenue lors de la sauvegarde.');
              });
            }

            function editBead(beadId) {
              showBeadModal('Modifier la perle', beadId);
            }

            function deleteBead(beadId) {
              if (confirm('Êtes-vous sûr de vouloir supprimer cette perle ?')) {
                const data = {
                  action: 'delete',
                  bead_id: beadId
                };

                fetch('{% url "beadmodels:user_settings" %}?tab=beads', {
                  method: 'POST',
                  headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': CSRF_TOKEN,
                    'X-Requested-With': 'XMLHttpRequest'
                  },
                  body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                  if (data.success) {
                    location.reload();
                  } else {
                    alert('Erreur: ' + data.message);
                  }
                })
                .catch(error => {
                  console.error('Erreur:', error);
                  alert('Une erreur est survenue lors de la suppression.');
                });
              }
            }
          </script>
        {% endif %}
      </div>
    </div>
  </div>

  {% if active_tab == 'shapes_new' or active_tab == 'shapes' %}
    <template id="shapeTemplate">
      <div class="shape-card" data-shape-id="">
        <div class="shape-header">
          <h4 class="shape-title"></h4>
        </div>
        <div class="mb-3">
          <label class="form-label">Type de forme</label>
          <select class="form-select shape-type" onchange="updateShapeControls(this)">
            <option value="rectangle">Rectangle</option>
            <option value="square">Carré</option>
            <option value="circle">Rond</option>
          </select>
        </div>
        <div class="shape-controls">
          <!-- Les contrôles seront ajoutés dynamiquement en fonction du type -->
        </div>
        <div class="shape-preview">
          <div class="shape-canvas">
            <!-- Les points seront ajoutés dynamiquement -->
          </div>
        </div>
        <div class="mt-4">
          <button type="button" class="btn btn-primary w-100" onclick="saveShape(this)">Enregistrer la forme</button>
        </div>
        <input type="hidden" class="shape-name" name="shape_name" />
      </div>
    </template>

    <script>
      let shapeCounter = 0
      let existingShapes = new Set()
      
      function generateUniqueName(baseName) {
        if (!existingShapes.has(baseName)) {
          existingShapes.add(baseName)
          return baseName
        }
      
        let counter = 1
        let newName
        do {
          counter++
          newName = `${baseName} (${counter})`
        } while (existingShapes.has(newName))
      
        existingShapes.add(newName)
        return newName
      }
      
      function updateShapeName(shapeCard) {
        const shapeType = shapeCard.querySelector('.shape-type').value
        const titleElement = shapeCard.querySelector('.shape-title')
        const shapeNameInput = shapeCard.querySelector('.shape-name')
        let baseName
      
        switch (shapeType) {
          case 'rectangle': {
            const width = parseInt(shapeCard.querySelectorAll('input[type="number"]')[0].value)
            const height = parseInt(shapeCard.querySelectorAll('input[type="number"]')[1].value)
            baseName = `Rectangle ${width}×${height}`
            break
          }
          case 'square': {
            const size = parseInt(shapeCard.querySelector('input[type="number"]').value)
            baseName = `Carré ${size}×${size}`
            break
          }
          case 'circle': {
            const diameter = parseInt(shapeCard.querySelector('input[type="number"]').value)
            baseName = `Rond ∅${diameter}`
            break
          }
        }
      
        // Si la forme a déjà un nom, on le garde, sinon on en génère un nouveau
        if (!shapeNameInput.value) {
          const uniqueName = generateUniqueName(baseName)
          titleElement.textContent = uniqueName
          shapeNameInput.value = uniqueName
        }
      }
      
      function saveShape(button) {
        const shapeCard = button.closest('.shape-card')
        const shapeData = {
          name: shapeCard.querySelector('.shape-name').value,
          type: shapeCard.querySelector('.shape-type').value,
          parameters: {}
        }
      
        const inputs = shapeCard.querySelectorAll('input[type="number"]')
        switch (shapeData.type) {
          case 'rectangle':
            shapeData.parameters.width = parseInt(inputs[0].value)
            shapeData.parameters.height = parseInt(inputs[1].value)
            break
          case 'square':
            shapeData.parameters.size = parseInt(inputs[0].value)
            break
          case 'circle':
            shapeData.parameters.diameter = parseInt(inputs[0].value)
            break
        }
      
        // Récupérer l'ID de la forme originale si elle existe
        const shapeId = shapeCard.dataset.shapeId
        if (shapeId && !shapeId.startsWith('shape-')) {
          shapeData.original_shape_id = shapeId
        }
      
        console.log('Données à envoyer:', shapeData)
      
        // Désactiver le bouton pendant la sauvegarde
        button.disabled = true
        button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Enregistrement...'
      
        // Récupérer le token CSRF
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value
      
        // Envoyer les données au serveur
        fetch('{% url "beadmodels:save_shape" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken,
            'X-Requested-With': 'XMLHttpRequest'
          },
          credentials: 'same-origin',
          body: JSON.stringify(shapeData)
        })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              window.location.href = '{% url "beadmodels:user_settings" %}?tab=shapes'
            } else {
              throw new Error(data.message || 'Une erreur est survenue lors de la sauvegarde.')
            }
          })
          .catch(error => {
            console.error('Erreur:', error)
            // Réactiver le bouton en cas d'erreur
            button.disabled = false
            button.innerHTML = 'Enregistrer la forme'
            alert(error.message || 'Une erreur est survenue lors de la sauvegarde.')
          })
      }
      
      function addNewShape() {
        const template = document.getElementById('shapeTemplate')
        const shapeList = document.getElementById('shapeList')
        const clone = template.content.cloneNode(true)
      
        shapeCounter++
        const shapeCard = clone.querySelector('.shape-card')
        shapeCard.dataset.shapeId = `shape-${shapeCounter}`
      
        shapeList.appendChild(clone)
        updateShapeControls(shapeCard.querySelector('.shape-type'))
      }
      
      function removeShape(button) {
        button.closest('.shape-card').remove()
      }
      
      function updateShapeControls(select) {
        const shapeCard = select.closest('.shape-card')
        const controlsDiv = shapeCard.querySelector('.shape-controls')
        const shapeType = select.value
      
        let controls = ''
      
        switch (shapeType) {
          case 'rectangle':
            controls = `
                                                                                  <div class="mb-3">
                                                                                    <label class="form-label">Largeur (pics)</label>
                                                                                    <input type="number" class="form-control" min="1" value="10" onchange="updatePreview(this)">
                                                                                  </div>
                                                                                  <div class="mb-3">
                                                                                    <label class="form-label">Hauteur (pics)</label>
                                                                                    <input type="number" class="form-control" min="1" value="8" onchange="updatePreview(this)">
                                                                                  </div>
                                                                                `
            break
          case 'square':
            controls = `
                                                                                  <div class="mb-3">
                                                                                    <label class="form-label">Taille (pics)</label>
                                                                                    <input type="number" class="form-control" min="1" value="10" onchange="updatePreview(this)">
                                                                                  </div>
                                                                                `
            break
          case 'circle':
            controls = `
                                                                                  <div class="mb-3">
                                                                                    <label class="form-label">Diamètre (pics)</label>
                                                                                    <input type="number" class="form-control" min="1" value="10" onchange="updatePreview(this)">
                                                                                  </div>
                                                                                `
            break
        }
      
        controlsDiv.innerHTML = controls
        updatePreview(select)
      }
      
      function updatePreview(input) {
        const shapeCard = input.closest('.shape-card')
        const canvas = shapeCard.querySelector('.shape-canvas')
        const shapeType = shapeCard.querySelector('.shape-type').value
        const titleElement = shapeCard.querySelector('.shape-title')
        const shapeNameInput = shapeCard.querySelector('.shape-name')
        let baseName
      
        // Nettoyer le canvas
        canvas.innerHTML = ''
      
        switch (shapeType) {
          case 'rectangle': {
            const width = parseInt(shapeCard.querySelectorAll('input')[0].value)
            const height = parseInt(shapeCard.querySelectorAll('input')[1].value)
            const spacing = 20
      
            canvas.style.width = `${width * spacing}px`
            canvas.style.height = `${height * spacing}px`
      
            for (let y = 0; y < height; y++) {
              for (let x = 0; x < width; x++) {
                const point = document.createElement('div')
                point.className = 'peg-point'
                point.style.left = `${x * spacing + spacing / 2}px`
                point.style.top = `${y * spacing + spacing / 2}px`
                canvas.appendChild(point)
              }
            }
            baseName = `Rectangle ${width}×${height}`
            break
          }
          case 'square': {
            const size = parseInt(shapeCard.querySelector('input').value)
            const spacing = 20
      
            canvas.style.width = `${size * spacing}px`
            canvas.style.height = `${size * spacing}px`
      
            for (let y = 0; y < size; y++) {
              for (let x = 0; x < size; x++) {
                const point = document.createElement('div')
                point.className = 'peg-point'
                point.style.left = `${x * spacing + spacing / 2}px`
                point.style.top = `${y * spacing + spacing / 2}px`
                canvas.appendChild(point)
              }
            }
            baseName = `Carré ${size}×${size}`
            break
          }
          case 'circle': {
            const diameter = parseInt(shapeCard.querySelector('input').value)
            const spacing = 20
            const radius = diameter / 2
      
            canvas.style.width = `${diameter * spacing}px`
            canvas.style.height = `${diameter * spacing}px`
      
            for (let y = 0; y < diameter; y++) {
              for (let x = 0; x < diameter; x++) {
                const dx = x - radius + 0.5
                const dy = y - radius + 0.5
                const distance = Math.sqrt(dx * dx + dy * dy)
      
                if (distance <= radius) {
                  const point = document.createElement('div')
                  point.className = 'peg-point'
                  point.style.left = `${x * spacing + spacing / 2}px`
                  point.style.top = `${y * spacing + spacing / 2}px`
                  canvas.appendChild(point)
                }
              }
            }
            baseName = `Rond ∅${diameter}`
            break
          }
        }
      
        // Mettre à jour le nom de la forme
        const uniqueName = generateUniqueName(baseName)
        titleElement.textContent = uniqueName
        shapeNameInput.value = uniqueName
      }
      
      // Ajouter une forme par défaut au chargement
      document.addEventListener('DOMContentLoaded', function () {
        addNewShape()
      })
    </script>

    <!-- Suppression des toasts -->
  {% endif %}

  <style>
    .color-btn {
      width: 30px;
      height: 30px;
      border: 2px solid #ddd;
      border-radius: 4px;
      cursor: pointer;
      padding: 0;
      transition: transform 0.2s;
    }

    .color-btn:hover {
      transform: scale(1.1);
    }

    .color-palette {
      margin-top: 1rem;
    }

    .bead-3d {
      position: relative;
      width: 100px;
      height: 100px;
      transform-style: preserve-3d;
      transform: rotateX(20deg) rotateY(45deg);
      transition: transform 0.3s ease;
      cursor: pointer;
      z-index: 1;
    }

    .bead-3d:hover {
      transform: rotateX(20deg) rotateY(45deg) scale(1.1);
    }

    .bead-body {
      position: absolute;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), transparent 60%);
      border-radius: 50%;
      box-shadow: 
        inset -5px -5px 15px rgba(0,0,0,0.3),
        inset 5px 5px 15px rgba(255,255,255,0.3),
        0 0 20px rgba(0,0,0,0.2);
      transition: background-color 0.3s ease;
      /* Créer l'effet de cylindre */
      background-image: 
        radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), transparent 60%),
        linear-gradient(to right, rgba(0,0,0,0.1), rgba(0,0,0,0.2));
      /* Ajouter le trou central */
      mask-image: radial-gradient(circle at center, transparent 40%, black 40%);
      -webkit-mask-image: radial-gradient(circle at center, transparent 40%, black 40%);
      pointer-events: none;
    }

    .bead-highlight {
      position: absolute;
      width: 100%;
      height: 100%;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.4), transparent 70%);
      border-radius: 50%;
      pointer-events: none;
      /* Ajouter le trou central */
      mask-image: radial-gradient(circle at center, transparent 40%, black 40%);
      -webkit-mask-image: radial-gradient(circle at center, transparent 40%, black 40%);
    }

    /* Ajouter un effet de profondeur pour le trou */
    .bead-body::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      width: 40%;
      height: 40%;
      background: rgba(0,0,0,0.2);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      pointer-events: none;
    }

    .bead-card {
      position: relative;
      transition: all 0.3s ease;
      min-height: 100px;
      transform: scale(1);
      cursor: pointer;
    }
    
    .bead-card:hover {
      transform: scale(1.05);
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    
    .bead-card .btn-group {
      opacity: 0;
      transition: all 0.3s ease;
      position: absolute;
      bottom: 8px;
      right: 8px;
      z-index: 1;
      display: flex;
      gap: 4px;
    }
    
    .bead-card:hover .btn-group {
      opacity: 1;
    }
    
    .bead-card .color-preview {
      transition: all 0.3s ease;
      margin-bottom: 8px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }
    
    .bead-card:hover .color-preview {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .bead-card .card-body {
      padding: 12px;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .bead-card .badge {
      font-size: 0.8rem;
      padding: 0.4em 0.6em;
      background-color: rgba(13, 110, 253, 0.9);
    }

    .bead-card .card-text {
      margin-bottom: 0;
      font-size: 0.85rem;
      flex-grow: 1;
    }

    .bead-card .btn-sm {
      padding: 0.25rem 0.5rem;
      font-size: 0.75rem;
      border-radius: 4px;
      background-color: rgba(255, 255, 255, 0.9);
      border: 1px solid rgba(0, 0, 0, 0.1);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
    }

    .bead-card .btn-sm:hover {
      background-color: rgba(255, 255, 255, 1);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }
  </style>
{% endblock %}
